import{Labeled as t,Perstext as e,Perscheck as i}from"@publishvue/vuecomps";import{Chessground as n}from"chessground";import{Pos as r}from"@publishvue/chessops";import*as s from"@publishvue/fetchclient";var o=function(){this.clear()},a={empty:{configurable:!0},now:{configurable:!0},size:{configurable:!0}};a.empty.get=function(){return!this.size},a.now.get=function(){return(new Date).getTime()},o.prototype.setItem=function(t,e){this.cache[t]=e,this.lastWrite=this.now},o.prototype.getItem=function(t){return this.cache[t]},o.prototype.clear=function(){this.cache={},this.lastWrite=this.now},a.size.get=function(){return Object.keys(this.cache).length},Object.defineProperties(o.prototype,a);var l=function(t){this.prodHost=t.prodHost||"",this.writeDelay=t.writeDelay||5e3,this.maxWriteDelay=t.maxWriteDelay||3e4,this.watchInterval=t.watchInterval||1e3,this.isRemoteKey=t.isRemoteKey||function(t){return!1},this.mockDelay=t.mockDelay||1500,this.authstoreFuncProt=t.authstoreFuncProt||"https:",this.authstoreFuncPath=t.authstoreFuncPath||".netlify/functions/authstore",this.vm=t.vm||null,this.authstoreFuncUrl=this.authstoreFuncProt+"//"+this.prodHost+"/"+this.authstoreFuncPath,this.cache=new o,this.writeBuffer=new o,this.lastWrite=this.cache.now,setInterval(this.watch.bind(this),this.watchInterval),this.setInfo("authstore ready "+this.authstoreFuncUrl)},u={isDev:{configurable:!0}};u.isDev.get=function(){return document.location.host!==this.prodHost},l.prototype.setItem=function(t,e){this.cache.setItem(t,e),this.writeBuffer.setItem(t,e)},l.prototype.getItem=function(t){var e=this;return new Promise((function(i){var n=e.cache.getItem(t);if(void 0===n){var r=JSON.parse(localStorage.getItem(t));if(null!==r)return e.cache.setItem(t,r),e.writeBuffer.setItem(t,r),void(e.isDev&&e.isRemoteKey(t)?setTimeout((function(t){i(r)}),e.mockDelay*(.5+Math.random())):i(r));e.isDev||fetch(e.authstoreFuncUrl,{method:"POST",body:JSON.stringify({ACTION:"get",DOCUMENT_ID:t,LICHESS_TOKEN:localStorage.getItem("LICHESS_TOKEN")})}).then((function(n){return n.json().then((function(n){if(console.log("authstore fetched",n),n){var r=JSON.parse(n.content);e.cache.setItem(t,r),i(r)}else e.cache.setItem(t,null),i(null)}))}))}else i(n)}))},l.prototype.shouldWrite=function(){return!this.writeBuffer.empty&&(this.writeBuffer.now-this.writeBuffer.lastWrite>this.writeDelay||this.writeBuffer.now-this.lastWrite>this.maxWriteDelay)},l.prototype.setInfo=function(t){console.log(t),this.vm&&(this.vm.authstoreInfo=t)},l.prototype.watch=function(){var t=this;if(this.shouldWrite()){this.lastWrite=this.cache.now;var e=this.writeBuffer.size;if(this.isDev){for(var i in this.writeBuffer.cache)localStorage.setItem(i,JSON.stringify(this.writeBuffer.cache[i]));return this.setInfo("written "+e+" item(s) at "+this.writeBuffer.now),void this.writeBuffer.clear()}var n=Object.entries(this.writeBuffer.cache).map((function(t){return{updateOne:{filter:{_id:t[0]},update:{$set:{content:JSON.stringify(t[1])}},upsert:!0}}}));console.log("bulk",n),this.setInfo("writing "+e+" item(s) at "+this.writeBuffer.now),fetch(this.authstoreFuncUrl,{method:"POST",body:JSON.stringify({ACTION:"bulkwrite",DOCUMENT:JSON.stringify(n),LICHESS_TOKEN:localStorage.getItem("LICHESS_TOKEN")})}).then((function(i){t.setInfo("written "+e+" item(s) at "+t.writeBuffer.now)})),this.writeBuffer.clear()}},Object.defineProperties(l.prototype,u);var h=function(t,e){return t(e={exports:{}},e.exports),e.exports}((function(t){function e(t){return t.split(" ").slice(0,4).join(" ")}function i(t){return t.replace(new RegExp("[+#]*","g"),"")}var n=["w","nw","n","ne","e","se","s","sw"];function r(t){var e=o(0,0);return t.includes("n")&&(e.y=-1),t.includes("s")&&(e.y=1),t.includes("e")&&(e.x=1),t.includes("w")&&(e.x=-1),e}var s=function(t,e){this.x=t,this.y=e};function o(t,e){return new s(t,e)}s.prototype.equalto=function(t){return this.x==t.x&&this.y==t.y},s.prototype.inverse=function(){return o(-this.x,-this.y)},s.prototype.angle=function(){var t=this.toPieceDirectionString();return Math.PI/4*n.indexOf(t)},s.prototype.toPieceDirectionString=function(){var t="";return this.y&&(t+=this.y<0?"n":"s"),this.x&&(t+=this.x>0?"e":"w"),t},s.prototype.normalized=function(){return 0==this.x&&0==this.y?null:this.x*this.y==0?o(Math.sign(this.x),Math.sign(this.y)):Math.abs(this.x)!=Math.abs(this.y)?null:o(Math.sign(this.x),Math.sign(this.y))};var a="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1";function l(){return[o(1,0),o(-1,0),o(0,1),o(0,-1),o(1,1),o(-1,-1),o(1,-1),o(-1,1)]}function u(){return[o(1,0),o(-1,0),o(0,1),o(0,-1)]}function h(t){return"l"==t.kind?[[t.direction],!0]:"r"==(e=t.kind)?[[o(1,0),o(-1,0),o(0,1),o(0,-1)],!0]:"b"==e?[[o(1,1),o(-1,-1),o(1,-1),o(-1,1)],!0]:"q"==e?[l(),!0]:"k"==e?[[o(1,0),o(-1,0),o(0,1),o(0,-1),o(1,1),o(-1,-1),o(1,-1),o(-1,1)],!1]:"n"==e?[[o(2,1),o(2,-1),o(-2,1),o(-2,-1),o(1,2),o(1,-2),o(-1,2),o(-1,-2)],!1]:"j"==e?[u(),!0]:"s"==e?[[o(1,1),o(-1,-1),o(1,-1),o(-1,1)],!0]:void 0;var e}var c={baserank:6,promrank:0,pushtwo:o(0,-2),pushone:o(0,-1),captures:[o(-1,-1),o(1,-1)]},p={baserank:1,promrank:7,pushtwo:o(0,2),pushone:o(0,1),captures:[o(-1,1),o(1,1)]};function f(t){return t?c:p}var d=[["standard","Standard",a],["chess960","Chess960",a],["crazyhouse","Crazyhouse","rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR[] w KQkq - 0 1"],["antichess","Giveaway","rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w - - 0 1"],["atomic","Atomic",a],["horde","Horde","rnbqkbnr/pppppppp/8/1PP2PP1/PPPPPPPP/PPPPPPPP/PPPPPPPP/PPPPPPPP w kq - 0 1"],["kingOfTheHill","King of the Hill",a],["racingKings","Racing Kings","8/8/8/8/8/8/krbnNBRK/qrbnNBRQ w - - 0 1"],["threeCheck","Three-check","rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 3+3 0 1"],["seirawan","S-Chess","rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR[HEhe] w KQBCDFGkqbcdfg - 0 1"],["eightpiece","8-Piece","jlsesqkbnr/pppppppp/8/8/8/8/PPPPPPPP/JLneSQKBNR w KQkq - 0 1 -"]];function v(t){return 0==t?0:7}function g(t){var e=d.find((function(e){return e[0]==t}));return e?e[2]:a}var y=function(t,e){this.file=t,this.rank=e};function b(t,e){return new y(t,e)}y.prototype.adddelta=function(t){return b(this.file+t.x,this.rank+t.y)},y.prototype.equalto=function(t){return!!t&&(this.file==t.file&&this.rank==t.rank)},y.prototype.clone=function(){return b(this.file,this.rank)};for(var k=[],w=0;w<8;w++)for(var q=0;q<8;q++)k.push(b(q,w));var S=function(t,e,i){this.kind=t,this.color=e,this.direction=i};function x(t,e,i){return new S(t,e,i)}S.prototype.isempty=function(){return!this.kind},S.prototype.toString=function(){if(this.isempty())return"-";var t=this.color?this.kind.toUpperCase():this.kind;return this.direction&&(t+=this.direction.toPieceDirectionString()),t},S.prototype.tocolor=function(t){return x(this.kind,t,this.direction)},S.prototype.colorInverse=function(){return this.tocolor(!this.color)},S.prototype.inverse=function(){var t=this.colorInverse();return"l"==this.kind&&(t.direction=t.direction.inverse()),t},S.prototype.equalto=function(t){if(this.direction&&t.direction){if(!this.direction.equalto(t.direction))return!1}else if(this.direction||t.direction)return!1;return this.kind==t.kind&&this.color==t.color},S.prototype.clone=function(){return x(this.kind,this.color,this.direction)},S.prototype.letter=function(){return this.color?this.kind.toUpperCase():this.kind};var C=function(t,e,i,n,r,s){this.fromsq=t,this.tosq=e,this.prompiece=i,this.epclsq=n,this.epsq=r,this.promsq=s};function _(t,e,i,n,r,s){return new C(t,e,i,n,r,s)}function I(t,e){var i=l().map((function(e){return x("l",t,e)}));return e&&(i=i.concat([x("x",!1,o(0,0))])),i}C.prototype.effpromsq=function(){return this.promsq||this.tosq},C.prototype.roughlyequalto=function(t){return this.fromsq.equalto(t.fromsq)&&this.tosq.equalto(t.tosq)},C.prototype.strictlyEqualTo=function(t){if(this.promsq){if(!t.promsq)return!1;if(!this.promsq.equalto(t.promsq))return!1}if(this.prompiece){if(!t.prompiece)return!1;if(!this.prompiece.equalto(t.prompiece))return!1}return this.fromsq.equalto(t.fromsq)&&this.tosq.equalto(t.tosq)};var T=function(t){this.props=t||{},this.variant=this.props.variant||"standard",this.rep=Array(64).fill(null),this.stack=[],this.setfromfen()},E={turnVerbal:{configurable:!0},reverseTurnVerbal:{configurable:!0}};function N(t){return new T(t)}function O(t){if(t.match(/:/))return null;var e,i={kind:"circle",color:"green",thickness:5,opacity:9,squares:[]},n=null;if(t.includes("@")){var r=t.split("@");t=r[0],n=r[1]}do{e=!1;var s=t.match(/^([lwxz])(.*)/);s&&(i.kind={l:"circle",w:"arrow",x:"square",z:"image"}[s[1]],t=s[2],e=!0),(s=t.match(/^([rnuy])(.*)/))&&(i.color={r:"red",n:"green",u:"blue",y:"yellow"}[s[1]],t=s[2],e=!0),(s=t.match(/^t([0-9])(.*)/))&&(i.thickness=parseInt(s[1]),t=s[2],e=!0),(s=t.match(/^o([0-9])(.*)/))&&(i.opacity=parseInt(s[1]),t=s[2],e=!0)}while(e);if(e=!0,n&&(t=n),"image"==i.kind)return m=t.match(/^([^\s#]*)(.*)/),i.name=m[1],i;do{m=t.match(/^([a-z][0-9])(.*)/),m?(i.squares.push(m[1]),t=m[2]):e=!1}while(e);return i}T.prototype.PROMOTION_PIECES=function(t,e){var i=[x("q",t,o(0,0)),x("r",t,o(1,0)),x("b",t,o(0,1)),x("n",t,o(1,1))];this.IS_SCHESS()?(i=i.concat([x("e",t,o(0,2)),x("h",t,o(1,2))]),e&&(i=i.concat([x("x",!1,o(0,3))]))):this.IS_EIGHTPIECE()?i=I(t,e).concat([x("j",t,o(-1,2)),x("q",t,o(0,2)),x("r",t,o(1,2)),x("s",t,o(-1,3)),x("b",t,o(0,3)),x("n",t,o(1,3))]):e&&(i=i.concat([x("x",!1,o(0,2))]));var n=i.map((function(t){return t.direction})).reduce((function(t,e){return e.rank>t?e.rank:t}),0);return t||i.forEach((function(t){return t.direction.y=n-t.direction.y})),i},T.prototype.status=function(){return this.legalmovesforallpieces().length?this.halfmoveclock>=100?{terminated:!0,result:.5,resultReason:"fifty move rule"}:{terminated:!1,result:null,resultReason:"in progress"}:this.iskingincheck(this.turn)?{terminated:!0,result:1==this.turn?0:1,resultReason:"mate"}:{terminated:!0,result:.5,resultReason:"stalemate"}},T.prototype.IS_ATOMIC=function(){return"atomic"==this.variant},T.prototype.IS_ANTICHESS=function(){return"antichess"==this.variant},T.prototype.IS_SCHESS=function(){return"seirawan"==this.variant},T.prototype.IS_EIGHTPIECE=function(){return"eightpiece"==this.variant},T.prototype.pieceStore=function(){return this.piecestorefen?this.piecestorefen.split("").map((function(t){return function(t){return t==t.toLowerCase()?new S(t,!1):new S(t.toLowerCase(),!0)}(t)})):[]},T.prototype.squareStore=function(){var t=this;return"-"==!this.castlefen?[]:this.castlefen.split("").map((function(e){switch(e){case"K":return t.rookorigsq("k",!0);case"Q":return t.rookorigsq("q",!0);case"k":return t.rookorigsq("k",!1);case"q":return t.rookorigsq("q",!1);default:var i=e.toLowerCase(),n=e!=i;return b(i.charCodeAt(0)-"a".charCodeAt(0),v(n))}}))},T.prototype.pieceStoreColor=function(t){return this.pieceStore().filter((function(e){return e.color==t}))},T.prototype.adjacentsquares=function(t){var e=this;return function(){for(var t=[],e=-1;e<=1;e++)for(var i=-1;i<=1;i++)0==e&&0==i||t.push(o(e,i));return t}().map((function(e){return t.adddelta(e)})).filter((function(t){return e.squareok(t)}))},T.prototype.jailerAdjacentSquares=function(t){var e=this;return u().map((function(e){return t.adddelta(e)})).filter((function(t){return e.squareok(t)}))},T.prototype.isSquareJailedBy=function(t,e){var i=this;return this.jailerAdjacentSquares(t).filter((function(t){return i.pieceatsquare(t).equalto(x("j",e))})).length>0},T.prototype.kingsadjacent=function(){var t=this.whereisking(!0);if(!t)return!1;var e=this.whereisking(!1);return!!e&&this.adjacentsquares(t).find((function(t){return t.equalto(e)}))},T.prototype.algebtosquare=function(t){return"-"==t?null:b(t.charCodeAt(0)-"a".charCodeAt(0),7-(t.charCodeAt(1)-"1".charCodeAt(0)))},T.prototype.algebtomovesimple=function(t){return null==t||"-"==t||""==t?null:_(this.algebtosquare(t.substring(0,2)),this.algebtosquare(t.substring(2,4)))},E.turnVerbal.get=function(){return this.turn?"white":"black"},E.reverseTurnVerbal.get=function(){return this.turn?"black":"white"},T.prototype.setfromfen=function(t,e){this.variant=e||this.variant,this.fen=t||g(this.variant),this.fenparts=this.fen.split(" "),this.rawfen=this.fenparts[0],this.rankfens=this.rawfen.split("/"),this.turnfen=this.fenparts[1],this.castlefen=this.fenparts[2],this.epfen=this.fenparts[3],this.halfmovefen=this.fenparts[4],this.fullmovefen=this.fenparts[5],this.disablefen=null,this.fenparts.length>6&&(this.disablefen=this.fenparts[6]);var i=this.rawfen.split(/\[|\]/);this.piecestorefen=i.length>1?i[1]:"",this.turn="w"==this.turnfen,this.epsq=this.algebtosquare(this.epfen),this.halfmoveclock=parseInt(this.halfmovefen),this.fullmovenumber=parseInt(this.fullmovefen);for(var n=0;n<64;n++)this.rep[n]=x();for(var s=0,o=0,a=this.rankfens;o<a.length;o+=1){var l=a[o],u=Array.from(l),h=0;do{var c=u[h++];if(c>="0"&&c<="9")for(var p=c.charCodeAt(0)-"0".charCodeAt(0),f=0;f<p;f++)this.rep[s++]=x();else{var d=c,m=!1;if(c>="A"&&c<="Z"&&(d=c.toLowerCase(),m=!0),"l"==d){var v=u[h++];if(["n","s"].includes(v)){var y=u[h];["e","w"].includes(y)&&(v+=y,h++)}this.rep[s++]=x(d,m,r(v))}else this.rep[s++]=x(d,m)}}while(h<u.length)}return this},T.prototype.pieceatsquare=function(t){return this.rep[t.file+8*t.rank]},T.prototype.toString=function(){for(var t="",e=0,i=k;e<i.length;e+=1){var n=i[e];t+=this.pieceatsquare(n).toString(),7==n.file&&(t+="\n")}return t},T.prototype.squaretoalgeb=function(t){return""+String.fromCharCode(t.file+"a".charCodeAt(0))+String.fromCharCode(7-t.rank+"1".charCodeAt(0))},T.prototype.movetoalgeb=function(t,e){var i;if(!t)return"-";if(this.IS_SCHESS()){if(t.castling){var n=t.fromsq,r=t.delrooksq;return t.placeCastlingPiece&&t.placeCastlingSquare.equalto(r)&&(n=(i=[r,n])[0],r=i[1]),""+this.squaretoalgeb(n)+this.squaretoalgeb(r)+(t.placeCastlingPiece?t.placeCastlingPiece.kind:"")}if(t.placePiece)return""+this.squaretoalgeb(t.fromsq)+this.squaretoalgeb(t.tosq)+t.placePiece.kind}var s=this.pieceatsquare(t.fromsq),o=this.pieceatsquare(t.tosq),a=t.prompiece?t.prompiece.kind:"";return("l"==s.kind||"s"==s.kind&&"l"==o.kind)&&(t.prompiece?a+=t.prompiece.direction.toPieceDirectionString():a+=s.direction.toPieceDirectionString()),t.promsq&&(a+="@"+this.squaretoalgeb(t.promsq)),!e&&t.castling?""+this.squaretoalgeb(t.fromsq)+this.squaretoalgeb(t.delrooksq):""+this.squaretoalgeb(t.fromsq)+this.squaretoalgeb(t.tosq)+a},T.prototype.squaretorepindex=function(t){return t.file+8*t.rank},T.prototype.setpieaceatsquare=function(t,e){this.rep[this.squaretorepindex(t)]=e},T.prototype.squaresForPieceKind=function(t,e){var i=this;return k.filter((function(n){var r=i.pieceatsquare(n);return r.kind==t&&r.color==e}))},T.prototype.attacksonsquarebylancer=function(t,e){for(var i=[],n=0,r=this.squaresForPieceKind("l",e);n<r.length;n+=1){var s=r[n],o=this.pseudolegalmovesforpieceatsquare(this.pieceatsquare(s),s);i=i.concat(o.filter((function(e){return e.tosq.equalto(t)})))}return i.map((function(t){return _(t.tosq,t.fromsq)}))},T.prototype.attacksonsquarebysentry=function(t,e){for(var i=[],n=0,r=this.squaresForPieceKind("s",e);n<r.length;n+=1){var s=r[n],o=this.pseudolegalmovesforpieceatsquare(this.pieceatsquare(s),s);i=i.concat(o.filter((function(t){return t.promsq}))).filter((function(e){return e.promsq.equalto(t)}))}return i.map((function(t){return _(t.promsq,t.fromsq)}))},T.prototype.attacksonsquarebypieceInner=function(t,e){var i=this;return"l"==e.kind?this.attacksonsquarebylancer(t,e.color):"s"==e.kind?this.attacksonsquarebysentry(t,e.color):this.pseudolegalmovesforpieceatsquare(e.inverse(),t).filter((function(t){return i.pieceatsquare(t.tosq).equalto(e)}))},T.prototype.attacksonsquarebypiece=function(t,e){var i=this;return this.attacksonsquarebypieceInner(t,e).filter((function(t){return!i.isSquareJailedBy(t.tosq,!e.color)}))},T.prototype.issquareattackedbycolor=function(t,e){var i=["q","r","b","n","k"];this.IS_SCHESS()&&(i=i.concat(["e","h"])),this.IS_EIGHTPIECE()&&(i=i.concat(["s"]));for(var n=0,r=i;n<r.length;n+=1){var s=r[n];if(this.attacksonsquarebypiece(t,x(s,e)).length>0)return!0}if(this.IS_EIGHTPIECE())for(var o=0,a=I(e);o<a.length;o+=1){var l=a[o];if(this.attacksonsquarebypiece(t,l).length>0)return!0}for(var u=0,h=f(!e).captures;u<h.length;u+=1){var c=h[u],p=t.adddelta(c);if(this.squareok(p)&&this.pieceatsquare(p).equalto(x("p",e)))return!0}return!1},T.prototype.whereisking=function(t){for(var e=x("k",t),i=0,n=k;i<n.length;i+=1){var r=n[i];if(this.pieceatsquare(r).equalto(e))return r}return null},T.prototype.iskingincheckAfterMove=function(t,e){this.push(t);var i=this.iskingincheck(e);return this.pop(),i},T.prototype.iskingincheck=function(t){var e=this.whereisking(t);if(this.IS_EIGHTPIECE()&&!e)return!0;if(this.IS_ATOMIC()){if(!e)return!0;if(!this.whereisking(!t))return!1;if(this.kingsadjacent())return!1}else if(!e)return!1;return this.issquareattackedbycolor(e,!t)},T.prototype.deletecastlingrights=function(t,e){if("-"!=this.castlefen){e&&(t=t.toUpperCase());for(var i=t.split(""),n=this.castlefen.split(""),r=o[s],s=0,o=i;s<o.length;s+=1)n=n.filter((function(t){return t!=r}));this.castlefen=n.length>0?n.join(""):"-"}},T.prototype.rookorigsq=function(t,e){return b("k"==t?7:0,e?7:0)},T.prototype.rookorigpiece=function(t,e){return this.IS_EIGHTPIECE()&&"q"==t?x("j",e):x("r",e)},T.prototype.castletargetsq=function(t,e){return b("k"==t?6:2,e?7:0)},T.prototype.rooktargetsq=function(t,e){return b("k"==t?5:3,e?7:0)},T.prototype.squaresbetween=function(t,e,i){var n=t.clone(),r=e.clone();if(r.file<n.file){var s=n;n=r,r=s}var o=[];i&&o.push(n.clone());var a=n,l=!0;do{a.file++,a.file<r.file?o.push(a.clone()):a.file==r.file?(i&&o.push(a.clone()),l=!1):(console.log("warning, squaresbetween received equal files"),l=!1)}while(l);return o},T.prototype.cancastle=function(t,e){var i=this;if(!this.castlefen.includes(e?t.toUpperCase():t))return!1;var n=this.whereisking(e);if(!n)return!1;var r=this.rookorigsq(t,e),s=this.squaresbetween(n,r);if(s.length!=s.filter((function(t){return i.pieceatsquare(t).isempty()})).length)return!1;for(var o=this.castletargetsq(t,e),a=0,l=this.squaresbetween(n,o,!0);a<l.length;a+=1){var u=l[a];if(this.issquareattackedbycolor(u,!e))return!1}if(this.IS_EIGHTPIECE()){if(this.isSquareJailedBy(this.rookorigsq(t,e),!e))return!1;if(this.isKingJailed(e))return!1}return!0},T.prototype.isKingJailed=function(t){var e=this.whereisking(t);return!!e&&this.isSquareJailedBy(e,!t)},T.prototype.getstate=function(){return{rep:this.rep.map((function(t){return t.clone()})),turn:this.turn,epsq:this.epsq?this.epsq.clone():null,halfmoveclock:this.halfmoveclock,fullmovenumber:this.fullmovenumber,rawfen:this.rawfen,turnfen:this.turnfen,castlefen:this.castlefen,epfen:this.epfen,halfmovefen:this.halfmovefen,fullmovefen:this.fullmovefen,disablefen:this.disablefen,piecestorefen:this.piecestorefen,fen:this.fen}},T.prototype.pushstate=function(){this.stack.push(this.getstate())},T.prototype.setstate=function(t){this.rep=t.rep,this.turn=t.turn,this.epsq=t.epsq,this.halfmoveclock=t.halfmoveclock,this.fullmovenumber=t.fullmovenumber,this.rawfen=t.rawfen,this.turnfen=t.turnfen,this.castlefen=t.castlefen,this.epfen=t.epfen,this.halfmovefen=t.halfmovefen,this.fullmovefen=t.fullmovefen,this.disablefen=t.disablefen,this.piecestorefen=t.piecestorefen,this.fen=t.fen},T.prototype.pop=function(){this.setstate(this.stack.pop())},T.prototype.algebtomove=function(t){var e=this;if(!t)return null;if("-"==t)return null;var i=this.legalmovesforallpieces(),n=i.find((function(i){return e.movetoalgeb(i)==t}));return n||i.find((function(i){return e.movetoalgeb(i,!0)==t}))},T.prototype.pushalgeb=function(t){var e=this.algebtomove(t);return!!e&&(this.push(e),!0)},T.prototype.removePlacePieceFromStore=function(t){var e=this.piecestorefen.split("");e=e.filter((function(e){return t.toString()!=e})),this.piecestorefen=e.join("")},T.prototype.removeSquareFromStore=function(t){var e=this.squaretoalgeb(t).substring(0,1);t.rank!=v(!0)?t.rank!=v(!1)||this.deletecastlingrights(e,!1):this.deletecastlingrights(e,!0)},T.prototype.push=function(t){this.pushstate();var e=this.pieceatsquare(t.fromsq),i=this.pieceatsquare(t.tosq);if(this.setpieaceatsquare(t.fromsq,x()),t.placePiece&&(this.setpieaceatsquare(t.fromsq,t.placePiece),this.removePlacePieceFromStore(t.placePiece)),t.placeMove&&this.removeSquareFromStore(t.fromsq),this.setpieaceatsquare(t.tosq,e),t.prompiece&&this.setpieaceatsquare(t.effpromsq(),t.promsq?t.prompiece:this.turn?t.prompiece.tocolor(!0):t.prompiece),t.promsq?"s"==e.kind&&"p"!=t.prompiece.kind&&(this.disablefen=this.movetoalgeb(_(t.promsq,t.tosq))):this.IS_EIGHTPIECE()&&(this.disablefen="-"),t.epclsq&&this.setpieaceatsquare(t.epclsq,x()),t.castling&&(this.setpieaceatsquare(t.delrooksq,x()),this.setpieaceatsquare(t.putrooksq,t.putrookpiece)),t.castling&&this.deletecastlingrights("kq",this.turn),this.IS_SCHESS()&&"k"==e.kind)for(var n=0,r=["k","q"];n<r.length;n+=1){var s=r[n];if(this.cancastle(s,this.turn)){var o=s,a=this.squaretoalgeb(this.rookorigsq(s,this.turn))[0];1==this.turn&&(o=o.toUpperCase(),a=a.toUpperCase()),this.castlefen=this.castlefen.replace(o,a)}}for(var l=0,u=["k","q"];l<u.length;l+=1){var h=u[l],c=this.rookorigsq(h,this.turn);this.pieceatsquare(c).equalto(this.rookorigpiece(h,this.turn))||this.deletecastlingrights(h,this.turn)}"k"==e.kind&&this.deletecastlingrights("kq",this.turn),this.turn=!this.turn,this.epsq=null,t.epsq&&(this.epsq=t.epsq),this.turnfen=this.turn?"w":"b",this.turn&&(this.fullmovenumber++,this.fullmovefen=""+this.fullmovenumber);var p=!1;i.isempty()||(p=!0),t.epclsq&&(p=!0);var f="p"==e.kind;if(p||f?this.halfmoveclock=0:this.halfmoveclock++,this.IS_ATOMIC()&&p){this.setpieaceatsquare(t.tosq,x());for(var d=0,m=this.adjacentsquares(t.tosq);d<m.length;d+=1){var v=m[d];"p"==this.pieceatsquare(v).kind||this.setpieaceatsquare(v,x())}}t.castling&&this.IS_SCHESS()&&t.placeCastlingPiece&&(this.setpieaceatsquare(t.placeCastlingSquare,t.placeCastlingPiece),this.removePlacePieceFromStore(t.placeCastlingPiece)),this.halfmovefen=""+this.halfmoveclock,this.epfen=this.epsq?this.squaretoalgeb(this.epsq):"-";for(var g="",y=0,b=0,w=k;b<w.length;b+=1){var q=w[b],S=this.pieceatsquare(q);S.isempty()?y++:(y>0&&(g+=""+y,y=0),g+=S.toString()),y>0&&7==q.file&&(g+=""+y,y=0),7==q.file&&q.rank<7&&(g+="/")}this.rawfen=g;var C=this.IS_SCHESS()?"["+this.piecestorefen+"]":"";this.fen=this.rawfen+C+" "+this.turnfen+" "+this.castlefen+" "+this.epfen+" "+this.halfmovefen+" "+this.fullmovefen,this.disablefen&&(this.fen+=" "+this.disablefen)},T.prototype.reportRawFen=function(){for(var t="",e=0,i=0,n=k;i<n.length;i+=1){var r=n[i],s=this.pieceatsquare(r);s.isempty()?e++:(e>0&&(t+=""+e,e=0),t+=s.toString()),e>0&&7==r.file&&(t+=""+e,e=0),7==r.file&&r.rank<7&&(t+="/")}return t},T.prototype.squareok=function(t){return t.file>=0&&t.rank>=0&&t.file<8&&t.rank<8},T.prototype.assertMaxPlmsGenDepth=function(t){return t<=1||(console.log("max plms gen depth 1 exceeded at depth "+t),!1)},T.prototype.pseudolegalmovesforpieceatsquare=function(t,e,i){var n=this,r=i||0;if(!this.assertMaxPlmsGenDepth(r))return[];var s=this.pieceatsquare(e);this.IS_EIGHTPIECE()&&"s"==t.kind&&this.setpieaceatsquare(e,x());var o=this.pseudolegalmovesforpieceatsquareinner(t,e,r),a=this.pieceStoreColor(t.color);if(this.IS_SCHESS()&&e.rank==v(t.color)){if(this.squareStore().find((function(t){return t.equalto(e)})))for(var l=function(){var i=h[u];o=o.concat(n.pseudolegalmovesforpieceatsquareinner(t,e,r).map((function(t){return t.placePiece=i,t})))},u=0,h=a;u<h.length;u+=1)l();o=o.map((function(t){return t.placeMove=!0,t}))}return this.setpieaceatsquare(e,s),o},T.prototype.pseudolegalmovesforpieceatsquareinner=function(t,e,i){var n=i||0;if(!this.assertMaxPlmsGenDepth(n))return[];if("e"==t.kind){var r=this.pseudolegalmovesforpieceatsquareinnerpartial(x("r",t.color),e,n);return r=r.concat(this.pseudolegalmovesforpieceatsquareinnerpartial(x("n",t.color),e,n))}if("h"==t.kind){var s=this.pseudolegalmovesforpieceatsquareinnerpartial(x("b",t.color),e,n);return s=s.concat(this.pseudolegalmovesforpieceatsquareinnerpartial(x("n",t.color),e,n))}return this.pseudolegalmovesforpieceatsquareinnerpartial(t,e,n)},T.prototype.pushLancerMoves=function(t,e,i){for(var s=0,o=n;s<o.length;s+=1){var a=o[s];t.push(_(i.fromsq,i.tosq,x("l",e,r(a))))}},T.prototype.pseudolegalmovesforpieceatsquareinnerpartial=function(t,e,i){var n=this,r=i||0;if(!this.assertMaxPlmsGenDepth(r))return[];var s=h(t),a=[],u=!0,c=!0,p=!0;if(this.IS_EIGHTPIECE()&&r>0&&(u=!1,c=!1,p=!1),"k"==t.kind&&this.isSquareJailedBy(e,!t.color)&&a.push(_(e,e.clone())),this.isSquareJailedBy(e,!t.color)&&p)return a;if(s)for(var d=0,m=s[0];d<m.length;d+=1){var v,g=m[d],y=e;do{if(y=y.adddelta(g),v=this.squareok(y)){var b=this.pieceatsquare(y);if("l"==t.kind)b.isempty()?this.pushLancerMoves(a,t.color,_(e,y)):b.color!=t.color&&(this.pushLancerMoves(a,t.color,_(e,y)),v=!1);else if(b.isempty())a.push(_(e,y));else if(b.color!=t.color){if("s"==t.kind){if(u){var k=this.pieceatsquare(y),w=k.colorInverse(),q=this.pseudolegalmovesforpieceatsquare(w,y,r+1),S=[],C=[];if(q.forEach((function(t){if(!C.find((function(e){return e.equalto(t.tosq)}))){var i=_(e,y,k,null,null,t.tosq);S.push(t.tosq),a.push(i),C.push(t.tosq)}})),"l"==k.kind)for(var P=0,I=this.adjacentsquares(y).filter((function(t){return n.pieceatsquare(t).isempty()}));P<I.length;P+=1)for(var T=I[P],E=[o(T.file-y.file,T.rank-y.rank)],N=function(){var t=A[O],i=_(e,y,x("l",k.color,t),null,null,T);i.nudge=!0,S.find((function(t){return t.equalto(i.promsq)}))||a.push(i)},O=0,A=E;O<A.length;O+=1)N()}}else"j"!=t.kind&&a.push(_(e,y));v=!1}else v=!1}}while(v&&s[1])}else if("p"==t.kind){var M=f(t.color),R=e.adddelta(M.pushone),z=!!this.squareok(R)&&this.pieceatsquare(R).isempty();if(z)if(R.rank==M.promrank)for(var B=0,F=this.PROMOTION_PIECES(t.color);B<F.length;B+=1){var D=F[B];"l"!=D.kind&&(D.direction=null),a.push(_(e,R,D))}else a.push(_(e,R));if(e.rank==M.baserank&&z){var H=e.adddelta(M.pushtwo);if(this.pieceatsquare(H).isempty()&&c){for(var j=null,L=0,G=M.captures;L<G.length;L+=1){var U=G[L],$=R.adddelta(U);this.squareok($)&&this.pieceatsquare($).equalto(x("p",!t.color))&&(j=R)}a.push(_(e,H,null,null,j))}}for(var K=0,V=M.captures;K<V.length;K+=1){var J=V[K],W=e.adddelta(J);if(this.squareok(W)){var Q=this.pieceatsquare(W);if(!Q.isempty()&&Q.color!=t.color)if(W.rank==M.promrank)for(var Y=0,X=this.PROMOTION_PIECES(t.color);Y<X.length;Y+=1){var Z=X[Y];"l"!=Z.kind&&(Z.direction=null),a.push(_(e,W,Z))}else a.push(_(e,W));if(Q.isempty()&&W.equalto(this.epsq)){var tt=_(e,W,null,W.adddelta(o(0,-M.pushone.y)));a.push(tt)}}}}if(this.IS_EIGHTPIECE()){var et=this.algebtomovesimple(this.disablefen);if(et){if(a=a.filter((function(t){return!t.roughlyequalto(et)})),"l"==t.kind&&e.equalto(et.fromsq))for(var it=0,nt=l().filter((function(e){return!e.equalto(t.direction)}));it<nt.length;it+=1)for(var rt=nt[it],st=!0,ot=e;st;)if(ot=ot.adddelta(rt),this.squareok(ot)){var at=this.pieceatsquare(ot);if(at.isempty()){var lt=_(e,ot,x("l",t.color,rt));lt.keepDirection=!0,a.push(lt)}else if(at.color!=t.color){var ut=_(e,ot,x("l",t.color,rt));ut.keepDirection=!0,a.push(ut),st=!1}}else st=!1;a=a.filter((function(e){if("n"!=t.kind&&"k"!=t.kind){var i=o(et.tosq.file-et.fromsq.file,et.tosq.rank-et.fromsq.rank).normalized();if(i)for(var r=e.fromsq.adddelta(i);n.squareok(r);){if(e.tosq.equalto(r))return!1;r=r.adddelta(i)}}return!0}))}}return a},T.prototype.pseudolegalmovesforallpieces=function(){for(var t=[],e=0,i=k;e<i.length;e+=1){var n=i[e],r=this.pieceatsquare(n);r.isempty()||r.color!=this.turn||(t=t.concat(this.pseudolegalmovesforpieceatsquare(r,n)))}return t},T.prototype.movecheckstatus=function(t){this.push(t);var e={meincheck:this.iskingincheck(!this.turn),oppincheck:this.iskingincheck(this.turn)};return this.pop(),e},T.prototype.createCastlingMove=function(t){var e=_(this.whereisking(this.turn),this.castletargetsq(t,this.turn));return e.castling=!0,e.san="k"==t?"O-O":"O-O-O",e.delrooksq=this.rookorigsq(t,this.turn),e.putrooksq=this.rooktargetsq(t,this.turn),e.putrookpiece=this.rookorigpiece(t,this.turn),e.passingSquares=this.squaresbetween(e.fromsq,e.delrooksq,!0),e},T.prototype.legalmovesforallpieces=function(){for(var t=[],e=0,i=this.pseudolegalmovesforallpieces();e<i.length;e+=1){var n=i[e],r=this.movecheckstatus(n);r.meincheck||(n.oppincheck=r.oppincheck,t.push(n))}for(var s=0,o=["k","q"];s<o.length;s+=1){var a=o[s];if(this.cancastle(a,this.turn)){var l=this.createCastlingMove(a);if(!this.iskingincheckAfterMove(l,this.turn)){t.push(l);var u=this.pieceStoreColor(this.turn);if(u.length&&this.IS_SCHESS())for(var h=0,c=u;h<c.length;h+=1){var p=c[h],f=this.createCastlingMove(a);f.placeCastlingPiece=p,f.placeCastlingSquare=l.fromsq,f.san+="/"+p.kind.toUpperCase()+this.squaretoalgeb(f.placeCastlingSquare),t.push(f);var d=this.createCastlingMove(a);d.placeCastlingPiece=p,d.placeCastlingSquare=this.rookorigsq(a,this.turn),d.san+="/"+p.kind.toUpperCase()+this.squaretoalgeb(d.placeCastlingSquare),t.push(d)}}}}return t},T.prototype.ismovecapture=function(t){return!!t.epclsq||!this.pieceatsquare(t.tosq).isempty()},T.prototype.santomove=function(t){var e=this;return null==t?null:this.legalmovesforallpieces().find((function(n){return i(e.movetosan(n))==i(t)}))},T.prototype.movetosan=function(t){var e=t.oppincheck?"+":"";if(t.oppincheck&&(this.push(t),0==this.legalmovesforallpieces().length&&(e="#"),this.pop()),t.castling)return t.san+e;var i=this.pieceatsquare(t.fromsq),n=this.ismovecapture(t),r=this.squaretoalgeb(t.fromsq),s=this.squaretoalgeb(t.tosq),o="";t.prompiece&&(o="="+t.prompiece.kind.toUpperCase(),"l"==t.prompiece.kind&&(o+=t.prompiece.direction.toPieceDirectionString()),t.promsq&&(o+="@"+this.squaretoalgeb(t.promsq)));var a=t.placePiece?"/"+t.placePiece.kind.toUpperCase():"";if("p"==i.kind)return n?r[0]+"x"+s+a+o+e:s+a+o+e;var l="",u=this.attacksonsquarebypiece(t.tosq,i);if("l"==i.kind){u=[];for(var h=0,c=I(i.color);h<c.length;h+=1)for(var p=c[h],f=this.attacksonsquarebypiece(t.tosq,p),d=function(){var t=v[m];u.find((function(e){return e.tosq.equalto(t.tosq)}))||u.push(t)},m=0,v=f;m<v.length;m+=1)d()}for(var g=[],y=[],b=!1,k=!1,w=0,q=u;w<q.length;w+=1){var S=q[w];g.includes(S.tosq.file)?b=!0:g.push(S.tosq.file),y.includes(S.tosq.rank)?k=!0:y.push(S.tosq.rank)}u.length>1&&(l=k&&b?r:b?r[1]:r[0]);var x=i.kind.toUpperCase();return n?x+l+"x"+s+o+e:x+l+s+a+o+e},T.prototype.squarefromalgeb=function(t){return b(t.charCodeAt(0)-"a".charCodeAt(0),7-(t.charCodeAt(1)-"1".charCodeAt(0)))},T.prototype.movefromalgeb=function(t){var e=new _(this.squarefromalgeb(t.slice(0,2)),this.squarefromalgeb(t.slice(2,4)));if(t.includes("@")){if(this.IS_SCHESS()){var i=this.squarefromalgeb(t.slice(2,4));return new _(i,i,new x(t.slice(0,1).toLowerCase(),"w"==this.turnfen))}if(this.IS_EIGHTPIECE()){var n=this.squarefromalgeb(t.match(/@(.*)/)[1]);e.promsq=n}}return e},Object.defineProperties(T.prototype,E);var A=function(t){this.fromBlob(t)};A.prototype.fromBlob=function(t){var e=t||{};return this.rating=e.rating||1500,this.rd=e.rd||250,this},A.prototype.serialize=function(){return{rating:this.rating,rd:this.rd}};var M=function(t){this.fromBlob(t)};function R(t){return new M(t)}M.prototype.equalTo=function(t){return this.id==t.id&&this.provider==t.provider},M.prototype.displayName=function(){return this.username||"@nonymous"},M.prototype.qualifiedDisplayName=function(t){var e=this.displayName();return this.provider&&(e+=" ( "+this.provider+" )"),t&&(e+=" "+this.glicko.rating),e},M.prototype.fromBlob=function(t){var e=t||{};return this.id=e.id,this.username=e.username,this.provider=e.provider,this.glicko=function(t){return new A(t)}(e.glicko),this.seated=!!e.seated,this.seatedAt=e.seatedAt||null,this.index=e.index||0,this.thinkingTime=e.thinkingTime||0,this.startedThinkingAt=e.startedThinkingAt||null,this.offerDraw=e.offerDraw,this},M.prototype.setIndex=function(t){return this.index=t,this},M.prototype.serialize=function(){return{id:this.id,username:this.username,provider:this.provider,glicko:this.glicko.serialize(),seated:this.seated,seatedAt:this.seatedAt,index:this.index,thinkingTime:this.thinkingTime,startedThinkingAt:this.startedThinkingAt,offerDraw:this.offerDraw}};var z=function(t){this.fromBlob(t)};z.prototype.fromBlob=function(t){var e=t||{};return this.author=R(e.author),this.msg=e.msg||"Chat message.",this.createdAt=(new Date).getTime(),this},z.prototype.serialize=function(){return{author:this.author.serialize(),msg:this.msg}},z.prototype.asText=function(){return this.author.qualifiedDisplayName()+" : "+this.msg};var B=function(t){this.fromBlob(t)};B.prototype.postMessage=function(t){for(this.messages.unshift(t),"delall"==t.msg&&(this.messages=[]);this.messages.length>this.capacity;)this.messages.pop()},B.prototype.fromBlob=function(t){var e=t||{};return this.capacity=e.capacity||100,this.messages=(e.messages||[]).map((function(t){return function(t){return new z(t)}(t)})),this},B.prototype.serialize=function(){return{capacity:this.capacity,messages:this.messages.map((function(t){return t.serialize()}))}},B.prototype.asText=function(){return this.messages.map((function(t){return t.asText()})).join("\n")};var F=function(t){this.fromBlob(t)};F.prototype.forEach=function(t){this.players.forEach(t)},F.prototype.hasPlayer=function(t){return this.players.find((function(e){return e.equalTo(t)}))},F.prototype.hasSeatedPlayer=function(t){var e=this.hasPlayer(t);return!!e&&e.seated},F.prototype.fromBlob=function(t){var e=t||{};this.players=[];for(var i=e.players||[],n=0;n<2;n++){var r=R(i.length?i.shift():null).setIndex(n);this.players.push(r)}return this},F.prototype.getByIndex=function(t){return this.players[t]},F.prototype.setPlayer=function(t){this.players[t.index]=t},F.prototype.getByColor=function(t){return t?this.getByIndex(1):this.getByIndex(0)},F.prototype.serialize=function(){return{players:this.players.map((function(t){return t.serialize()}))}};var D=function(t){this.fromBlob(t)};function H(t){return new D(t)}D.prototype.fromBlob=function(t){var e=t||{};return this.initial=e.initial||3,this.increment=e.increment||2,this},D.prototype.serialize=function(){return{initial:this.initial,increment:this.increment}},D.prototype.toString=function(){return this.initial+" + "+this.increment};var j=function(){},L={strippedfen:{configurable:!0},analysiskey:{configurable:!0},depth:{configurable:!0}};function G(){return new j}j.prototype.getMove=function(){return this.parentid?N().setfromfen(this.getparent().fen,this.parentgame.variant).santomove(this.gensan):null},L.strippedfen.get=function(){return e(this.fen)},L.analysiskey.get=function(){return"analysis/"+this.parentgame.variant+"/"+this.strippedfen},j.prototype.hasSan=function(t){var e=this;return this.childids.find((function(i){return e.parentgame.gamenodes[i].gensan==t}))},L.depth.get=function(){for(var t=0,e=this;e.parentid;)e=e.getparent(),t++;return t},j.prototype.stripCommentOfImages=function(){this.comment=this.comment.replace(/#z[^#\s]*/g,"")},j.prototype.stripCommentOfDelays=function(){this.comment=this.comment.replace(/#delay:[^#\s]*/g,"")},j.prototype.addImageToComment=function(t,e){e&&this.stripCommentOfDelays(),this.stripCommentOfImages(),this.comment+="#z@"+t,this.comment+="#delay:"+e},j.prototype.fromblob=function(t,e){return this.parentgame=t,this.id=e.id,this.genalgeb=e.genalgeb,this.gensan=e.gensan,this.fen=e.fen,this.childids=e.childids||[],this.parentid=e.parentid||null,this.weights=(e.weights||[0,0]).map((function(t){return parseInt(t)})),this.error=e.error,this.priority=0,this.comment=e.comment||"",this.hasEval=e.hasEval||!1,this.eval=e.eval||null,this},j.prototype.props=function(){return function(t){var e={},i=!0;do{var n=t.match(/([^#]*)#([^#:]+):([^#\s]*)(.*)/);n?(t=n[1]+n[4],e[n[2]]=n[3]):i=!1}while(i);return e}(this.comment)},j.prototype.drawings=function(){return function(t){var e=[],i=!0;do{var n=t.match(/([^#]*)#([^#\s]*)(.*)/);if(n){t=n[1]+n[3];var r=O(n[2]);r&&e.push(r)}else i=!1}while(i);return e}(this.comment)},j.prototype.fullmovenumber=function(){var t=this.getparent();return t?parseInt(t.fen.split(" ")[5]):null},j.prototype.regid=function(){return this.id.replace(/\+/g,"\\+")},j.prototype.subnodes=function(){var t=[];for(var e in this.parentgame.gamenodes)e.match(new RegExp("^"+this.regid()+"_"))&&t.push(this.parentgame.gamenodes[e]);return t},j.prototype.turn=function(){return this.fen.match(/ w/)},j.prototype.getparent=function(){return this.parentid?this.parentgame.gamenodes[this.parentid]:null},j.prototype.siblings=function(t){var e=this;if(!this.parentid)return[];var i=this.getparent().sortedchilds();return t&&(i=i.filter((function(t){return t.id!=e.id}))),i},j.prototype.geterror=function(){return this.error?this.error:0},j.prototype.moderror=function(t){this.error=this.geterror()+t,this.error<0&&(this.error=0)},j.prototype.moderrorrec=function(t){for(var e=this;e;)e.moderror(t),(e=e.getparent())&&(e=e.getparent())},j.prototype.opptrainweight=function(){return this.weights[0]+this.weights[1]},j.prototype.metrainweight=function(){return this.weights[0]},j.prototype.sortweight=function(){return 100*this.priority+10*this.weights[0]+this.weights[1]},j.prototype.sortchildids=function(t,e){var i=this.parentgame.gamenodes[t];return this.parentgame.gamenodes[e].sortweight()-i.sortweight()},j.prototype.sortedchilds=function(){var t=this;return this.childids.sort(this.sortchildids.bind(this)).map((function(e){return t.parentgame.gamenodes[e]}))},j.prototype.sortedchildsopp=function(){return this.sortedchilds().filter((function(t){return t.opptrainweight()>0}))},j.prototype.sortedchildsme=function(){return this.sortedchilds().filter((function(t){return t.metrainweight()>0}))},j.prototype.revsortedchilds=function(){return this.sortedchilds().reverse()},j.prototype.serialize=function(){return{id:this.id,genalgeb:this.genalgeb,gensan:this.gensan,fen:this.fen,childids:this.childids,parentid:this.parentid,weights:this.weights,error:this.error,comment:this.comment,hasEval:this.hasEval,eval:this.eval}},j.prototype.clone=function(){return G().fromblob(this.parentgame,this.serialize())},Object.defineProperties(j.prototype,L);var U=function(t){this.fromBlob(t)};function $(t){return new U(t)}U.prototype.fromBlob=function(t){return this.blob=t||[],this},U.prototype.getKey=function(t){return this.blob.find((function(e){return e[0]==t}))},U.prototype.get=function(t){var e=this.getKey(t);return e?e[1]:null},U.prototype.setKey=function(t,e){var i=this.getKey(t);i?i[1]=e:this.blob.push([t,e])};var K=function(t){this.fromblob(t)},V={allNodes:{configurable:!0},forAllNodes:{configurable:!0}};function J(t){return new K(t)}K.prototype.getRandomMove=function(){var t=this.board.legalmovesforallpieces();return t.length?t[Math.floor(Math.random()*t.length)]:null},K.prototype.getForwardMove=function(){var t=this.getcurrentnode().sortedchilds();return t.length?t[0].getMove():null},K.prototype.offerDraw=function(t){var e=this.players.hasPlayer(t);return e?(e.offerDraw=!0,this.drawAccepted()&&this.terminate(.5,"draw agreed"),!0):"Only playing sides can offer draw."},K.prototype.revokeDraw=function(t){var e=this.players.hasPlayer(t);return e?(e.offerDraw=!1,!0):"Only playing sides can revoke draw."},K.prototype.drawOffered=function(){var t=!1;return this.players.forEach((function(e){e.offerDraw&&(t=!0)})),t},K.prototype.drawAccepted=function(){var t=!0;return this.players.forEach((function(e){e.offerDraw||(t=!1)})),t},K.prototype.turnPlayer=function(){return this.players.getByColor(this.board.turn)},K.prototype.oppTurnPlayer=function(){return this.players.getByColor(!this.board.turn)},K.prototype.canMakeMove=function(t){return this.turnPlayer().equalTo(t)},K.prototype.turnMoveTime=function(){return(new Date).getTime()-this.turnPlayer().startedThinkingAt},K.prototype.turnTimeLeft=function(){return Math.max(this.turnPlayer().thinkingTime-this.turnMoveTime(),0)},K.prototype.checkTurnTimedOut=function(t){if(!this.inProgress)return!1;var e=this.turnTimeLeft();return t&&(this.turnPlayer().thinkingTime=e),e<=0&&(this.terminate(1==this.board.turn?0:1,"flagged"),!0)},K.prototype.isRepetition=function(t){var i={};for(var n in this.gamenodes){var r=e(this.gamenodes[n].fen);if(i[r]?i[r]++:i[r]=1,i[r]>=t)return!0}return!1},K.prototype.makeSanMoveResult=function(t){if(this.checkTurnTimedOut(!0))return!0;if(this.makeSanMove(t)){var e=this.board.status();return e.terminated?(this.terminate(e.result,e.resultReason),!0):this.isRepetition(3)?(this.terminate(.5,"threefold repetition"),!0):(this.oppTurnPlayer().thinkingTime+=1e3*this.timecontrol.increment,this.startThinking(),!0)}return"Illegal move."},K.prototype.makeSanMove=function(t){var e=t.match(/[0-9\.]*(.*)/)[1];if(!e)return!1;var i=this.board.santomove(e);return!!i&&(this.makemove(i),!0)},K.prototype.mergeGameRecursive=function(t){for(var e=0,i=t.sortedchilds();e<i.length;e+=1){var n=i[e];this.makeSanMove(n.gensan)&&(n.comment&&(this.getcurrentnode().comment=n.comment),this.mergeGameRecursive(n),this.back())}},K.prototype.mergeGame=function(t){return t.getrootnode().fen!=this.getcurrentnode().fen?"Merge game failed. Game root fen does not match current fen.":(this.mergeGameRecursive(t.getrootnode()),"Game merged ok.")},K.prototype.buildFromPGN=function(t,e,i){var n=i||"standard",r=N().setfromfen(null,n).fen;this.pgnHeaders=$(t),this.pgnBody=e;var s,o=this.pgnHeaders.get("Variant"),a=this.pgnHeaders.get("FEN");o&&(n=(s=o).substring(0,1).toLowerCase()+s.substring(1)),a&&(r=a),this.setfromfen(r,n);for(var l="",u=0,h=[],c=0,p=(this.pgnBody+" ").split("");c<p.length;c+=1){var f=p[c];"("==f?u?l+=f:(l&&(this.makeSanMove(l),l=""),h.push(this.getcurrentnode().clone()),this.back()):")"==f?u?l+=f:(l&&(this.makeSanMove(l),l=""),this.setfromnode(h.pop())):"{"==f?(u?l+="{":l&&(this.makeSanMove(l),l=""),u++):"}"==f?u&&(--u?l+="}":l&&(this.getcurrentnode().comment=l,l="")):" "==f?u?l+=" ":l&&(this.makeSanMove(l),l=""):l+=f}return this},K.prototype.parsePGN=function(t,e){var i=function(t){for(var e=!0,i=!1,n=[],r=[];t.length&&!t[0];)t.shift();do{var s=t.shift(),o=void 0;if(e)s?(o=s.match(/^\[([^ ]+) \"([^\"]+)/))?n.push([o[1],o[2]]):(e=!1,t.unshift(s)):e=!1;else if(i){if(!s)return[t,n,r.join("\n")];r.push(s)}else s&&(i=!0,r.push(s))}while(t.length);return[t,n,r.join("\n")]}(t.split("\n"));return this.buildFromPGN(i[1],i[2],e),[i[0],this]},K.prototype.setHeaders=function(t){this.pgnHeaders.fromBlob(t),this.setDefaultPgnHeaders()},K.prototype.nodesForFen=function(t){return Object.entries(this.gamenodes).filter((function(t){return t[1].parentid})).filter((function(i){return e(i[1].getparent().fen)==e(t)})).map((function(t){return t[1]}))},K.prototype.bookForFen=function(t){var e={};return this.nodesForFen(t).forEach((function(t){e[t.genalgeb]||(e[t.genalgeb]=[0,0]),e[t.genalgeb][0]+=t.weights[0],e[t.genalgeb][1]+=t.weights[1]})),e},K.prototype.weightedAlgebForFen=function(t,e){var i=[],n=this.bookForFen(t),r=function(t){var r=e.reduce((function(e,i){return e+n[t][i]}),0);i=i.concat(Array(r).fill(t))};for(var s in n)r(s);return i.length?i[Math.floor(Math.random()*i.length)]:null},V.allNodes.get=function(){return Object.entries(this.gamenodes).map((function(t){return t[1]}))},V.forAllNodes.get=function(){return this.allNodes.forEach},K.prototype.removePriority=function(){this.forAllNodes((function(t){return t.priority=0}))},K.prototype.fen=function(){return this.getcurrentnode().fen},K.prototype.merge=function(t){if(this.removePriority(),t.tobegin(),this.tobegin(),t.fen()!=this.fen())return"Merge failed, starting positions don't match.";for(var e=0;t.forward();){var i=t.getcurrentnode().gensan,n=this.board.santomove(i);if(!n)return"Merge detected invalid san ( move: "+e+", san: "+i+" ).";this.makemove(n);for(var r=this.getcurrentnode(),s=0,o=r.siblings(!0);s<o.length;s+=1){o[s].priority=0}r.priority=1,e++}return"Merged all "+e+" move(s) ok."},K.prototype.fromsans=function(t){this.setfromfen(g(this.variant));for(var e=0,i=t;e<i.length;e+=1){var n=i[e],r=this.board.santomove(n);if(!r)return this;this.makemove(r)}return this},K.prototype.setfromfen=function(t,e){return this.variant=e||this.variant,this.board.setfromfen(t,this.variant),this.gamenodes={root:G().fromblob(this,{parentgame:this,id:"root",genalgeb:null,gensan:null,fen:this.board.fen})},this.currentnodeid="root",this.pgnHeaders.blob=[],this.setDefaultPgnHeaders(),this},K.prototype.reset=function(t){this.setfromfen(null,t)},K.prototype.setfromnode=function(t){this.currentnodeid=t.id,this.board.setfromfen(this.getcurrentnode().fen,this.variant)},K.prototype.makemove=function(t){var e=this.board.movetoalgeb(t),i=this.board.movetosan(t);this.board.push(t),this.makemovenode(G().fromblob(this,{genalgeb:e,gensan:i,fen:this.board.fen}))},K.prototype.setTimecontrol=function(t,e){return this.players.hasSeatedPlayer(t)?(this.variant=e.variant,this.timecontrol=H(e.timecontrol),!0):"Only seated players can set time control."},K.prototype.hasAllPlayers=function(){return this.players.getByColor(!0).seated&&this.players.getByColor(!1).seated},K.prototype.terminate=function(t,e){this.inProgress=!1,this.terminated=!0,this.terminatedAt=(new Date).getTime(),this.result=t,this.resultReason=e,this.players.forEach((function(t){t.seated=!1,t.seatedAt=null})),this.terminationCallback&&this.terminationCallback()},K.prototype.resignPlayer=function(t){return this.inProgress?this.players.hasPlayer(t)?(0==t.index?this.terminate(1,"black resigned"):this.terminate(0,"white resigned"),!0):"You can only resign your own game.":"You can only resign an ongoing game."},K.prototype.sitPlayer=function(t,e){var i=this.players.getByIndex(t.index);if(i.seated&&i.id!=t.id){var n=(new Date).getTime()-i.seatedAt;if(n<3e5)return"Player can be unseated after "+function(t,e){var i="",n=Math.floor(t/36e5);t>36e5&&(t-=36e5*n,i+=n+" hour",n>1&&(i+="s"),i+=" , ");var r=Math.floor(t/6e4);t>6e4&&(t-=6e4*r,i+=r+" minute",r>1&&(i+="s"),i+=" , ");var s=Math.floor(t/1e3);return i+=s+" second",s>1&&(i+="s"),e?i:(""+n).padStart(2,"0")+":"+(""+r).padStart(2,"0")+":"+(""+s).padStart(2,"0")}(3e5-n,!0)+"."}if(e)t=R().setIndex(t.index);else{if(this.players.hasSeatedPlayer(t))return"Already seated.";t.seated=!0,t.seatedAt=(new Date).getTime()}return this.players.setPlayer(t),this.hasAllPlayers()?this.startGame():this.terminated&&(this.playerSeatedAfterTermination=!0),!0},K.prototype.startThinking=function(){this.turnPlayer().startedThinkingAt=(new Date).getTime()},K.prototype.startGame=function(){var t=this;this.inProgress=!0,this.terminated=!1,this.result=null,this.resultReason="in progress",this.setfromfen(null,this.variant),this.players.forEach((function(e){e.thinkingTime=60*t.timecontrol.initial*1e3,e.offerDraw=!1})),this.startedAt=(new Date).getTime(),this.playerSeatedAfterTermination=!1,this.chat.messages=[],this.startThinking(),this.startCallback&&this.startCallback()},K.prototype.fromblob=function(t){var e=t||{};this.board=N(),this.variant=e.variant||"standard",this.pgnHeaders=$(e.pgnHeaders),this.pgnBody=e.pgnBody||"*",this.setfromfen(null,null);var i,n=e.gamenodes||{};for(var r in n)this.gamenodes[r]=G().fromblob(this,n[r]);return this.currentnodeid=e.currentnodeid||"root",this.board.setfromfen(this.getcurrentnode().fen,this.variant),this.setDefaultPgnHeaders(),this.flip=!!e.flip,this.animations=e.animations||[],this.selectedAnimation=e.selectedAnimation,this.animationDescriptors=e.animationDescriptors||{},this.timecontrol=H(e.timecontrol),this.players=(i=e.players,new F(i)),this.inProgress=!!e.inProgress,this.terminated=!!e.terminated,this.result=e.result,this.resultReason=e.resultReason||"in progress",this.startedAt=e.startedAt||null,this.terminatedAt=e.terminatedAt||null,this.chat=function(t){return new B(t)}(e.chat),this.playerSeatedAfterTermination=e.playerSeatedAfterTermination,this},K.prototype.playersVerbal=function(){return this.players.getByColor(!0).qualifiedDisplayName(!0)+" - "+this.players.getByColor(!1).qualifiedDisplayName(!0)},K.prototype.resultVerbal=function(){return 1==this.result?"1 - 0":0==this.result?"0 - 1":"1/2 - 1/2"},K.prototype.setDefaultPgnHeaders=function(){var t;this.pgnHeaders.setKey("Variant",(t=this.variant).substring(0,1).toUpperCase()+t.substring(1)),this.pgnHeaders.setKey("FEN",this.getrootnode().fen)},K.prototype.subtree=function(t,e,i){var n=t.clone();e?(n.id=i.join("_"),n.parentid=i.slice(0,i.length-1).join("_")):(e={},n.id="root",n.genalgeb=null,n.gensan=null,n.parentid=null,i=["root"]),e[n.id]=n;for(var r=[],s=0,o=t.sortedchilds();s<o.length;s+=1){var a=o[s],l=i.concat(a.gensan);this.subtree(a,e,l);var u=l.join("_");r.push(u)}return n.childids=r,e},K.prototype.subtreeSize=function(t){var e=t||this.getcurrentnode();return Object.entries(this.subtree(e)).length},K.prototype.reduce=function(t){var e=t||this.getcurrentnode();return J().fromblob(Object.assign({},this.serialize(),{gamenodes:this.subtree(e),currentnodeid:"root"}))},K.prototype.reduceLine=function(t){for(var e=this,i=t||this.getcurrentnode();i.parentid;){var n=i;(i=i.getparent()).childids.length>1&&i.sortedchilds().slice(1).forEach((function(t){for(var i in e.gamenodes)i.match(new RegExp("^"+t.regid()))&&delete e.gamenodes[i]})),i.childids=[n.id]}},K.prototype.pgninfo=function(t){var e=this.getrootnode(),i=[],n=this.currentnodeid;if(t)for(this.currentnodeid="root";this.forward();)i.push(this.getcurrentnode().gensan);else for(var r=this.getcurrentnode();this.back();)i.unshift(r.gensan),r=this.getcurrentnode();return this.currentnodeid=n,{variant:this.variant,initialFen:e.fen,pgnMoves:i,white:"?",black:"?",date:"?"}},K.prototype.movewithnumber=function(t,e,i,n,r){var s=t.fen.split(" "),o=s[5]+".";"w"==s[1]&&(o=parseInt(s[5])-1+".."),r&&(o="");var a="";if(i&&t.comment&&(a=" { "+t.comment+" }"),"object"==typeof i){a="";var l=i[t.analysiskey];if(l){var u=new Q(l);if(u.hasScorenumerical){var h=-u.scorenumerical;a=" { "+(h>0?"+":"")+h+" }"}}if(t.hasEval){var c=-t.eval;a=" { "+(c>0?"+":"")+c+" }"}}return(("b"==s[1]||e)&&o?o+" ":"")+(n?t.genalgeb:t.gensan)+a},K.prototype.line=function(t,e,i,n){for(var r=this,s=e||this.getcurrentnode(),o=[];s;)o.unshift(s),s=s.getparent();o.shift();var a=!0;return o.map((function(e){var s=r.movewithnumber(e,a,t,i,n);return a=!1,s})).join(" ")},K.prototype.multiPGN=function(t){var e=t.rootNode.sortedchilds();if(!e.length)return t.buff;var i=e[0];if(t.variationStart||(t.buff+=" "),t.buff+=this.movewithnumber(i,t.variationStart,t.docomments,t.reportAsUCI),e.length>1)for(var n=0,r=e.slice(1);n<r.length;n+=1){var s=r[n];t.buff+=" ( ",t.buff+=this.movewithnumber(s,!0,t.docomments,t.reportAsUCI),t.buff=this.multiPGN({docomments:t.docomments,rootNode:s,variationStart:!1,buff:t.buff}),t.buff+=" )"}return this.multiPGN({docomments:t.docomments,rootNode:i,variationStart:!1,buff:t.buff,reportAsUCI:t.reportAsUCI})},K.prototype.reportPgnHeaders=function(t){this.pgnHeaders.setKey("FEN",t?t.fen:this.getrootnode().fen);var e=this.pgnHeaders.blob.map((function(t){return"["+t[0]+' "'+t[1]+'"]'})).join("\n");return this.pgnHeaders.setKey("FEN",this.getrootnode().fen),e},K.prototype.pgn=function(t,e,i,n,r){var s=e||this.getrootnode();return this.reportPgnHeaders(n?this.getrootnode():s)+"\n\n"+(i?this.multiPGN({docomments:t,rootNode:s,variationStart:!n||"root"==s.id,buff:n?this.line(!1,s,r):"",reportAsUCI:r}):this.line(t,null,r))},K.prototype.getcurrentnode=function(){return this.gamenodes[this.currentnodeid]},K.prototype.getrootnode=function(){return this.gamenodes.root},K.prototype.tnodecmp=function(t,e){return e.subnodes().length-t.subnodes().length},K.prototype.transpositions=function(t){var e=t||this.getcurrentnode(),i=Object.entries(this.gamenodes).filter((function(t){return t[1].fen==e.fen})).map((function(t){return t[1]}));return i.sort(this.tnodecmp),i},K.prototype.makemovenode=function(t){var e=this.getcurrentnode();t.id=this.currentnodeid+"_"+t.gensan,e.childids.includes(t.id)||(e.childids.push(t.id),t.parentid=this.currentnodeid,this.gamenodes[t.id]=t),this.currentnodeid=t.id,this.transpositions(this.getcurrentnode())[0].id,this.board.setfromfen(this.getcurrentnode().fen,this.variant)},K.prototype.back=function(){var t=this.getcurrentnode();return!!t.parentid&&(this.currentnodeid=t.parentid,this.board.setfromfen(this.getcurrentnode().fen,this.variant),!0)},K.prototype.del=function(){var t=this.getcurrentnode(),e=t.parentid;if(e){for(var i in this.gamenodes)i.match(new RegExp("^"+t.regid()))&&delete this.gamenodes[i];this.currentnodeid=e;var n=this.getcurrentnode();return n.childids=n.childids.filter((function(e){return e!=t.id})),this.board.setfromfen(this.fen(),this.variant),!0}return!1},K.prototype.tobegin=function(){if(!this.back())return!1;for(;this.back(););return!0},K.prototype.toend=function(){if(!this.forward())return!1;for(;this.forward(););return!0},K.prototype.forward=function(){var t=this.getcurrentnode();return t.childids.length>0&&(this.currentnodeid=t.sortedchilds()[0].id,this.board.setfromfen(this.getcurrentnode().fen,this.variant),!0)},K.prototype.serialize=function(){var t={};for(var e in this.gamenodes)t[e]=this.gamenodes[e].serialize();return{variant:this.variant,flip:this.flip,gamenodes:t,currentnodeid:this.currentnodeid,animations:this.animations,selectedAnimation:this.selectedAnimation,animationDescriptors:this.animationDescriptors,pgnHeaders:this.pgnHeaders.blob,pgnBody:this.pgnBody,timecontrol:this.timecontrol.serialize(),players:this.players.serialize(),inProgress:this.inProgress,terminated:this.terminated,result:this.result,resultReason:this.resultReason,startedAt:this.startedAt,terminatedAt:this.terminatedAt,chat:this.chat.serialize(),playerSeatedAfterTermination:this.playerSeatedAfterTermination}},K.prototype.clone=function(){return J().fromblob(this.serialize())},Object.defineProperties(K.prototype,V);var W=function(t,e){this.sendanalysisinfo=t,this.path=e,this.spawn(),setInterval(this.checkcommand.bind(this),200)};W.prototype.setcommand=function(t,e){this.command=t,this.payload=e},W.prototype.play=function(t,e,i,n,r){var s=this;return P((function(o){s.resolvePlay=o,s.go({fen:t,moves:e,variant:i,timecontrol:n,moveOverHead:r})}))},W.prototype.processstdoutline=function(t){var e=this;if(!t.match(/^info string/)){var i=t.match(/^bestmove ([^\s]+)/);if(i){var n=i[1];if(this.analysisinfo.state=0,this.sendanalysisinfo(JSON.parse(JSON.stringify(this.analysisinfo))),this.resolvePlay){var r=null;try{r=this.analysisinfo.summary[0].scorenumerical}catch(t){}this.resolvePlay({bestmove:n,scorenumerical:r}),this.resolvePlay=null}}else if(t.match(/^info/)){var s=null,o=t.match(/ depth (.+)/);o&&(s=parseInt(o[1]));var a=t.match(/ time (.+)/);a&&(this.analysisinfo.time=parseInt(a[1]));var l=t.match(/ nodes (.+)/);l&&(this.analysisinfo.nodes=parseInt(l[1]));var u=t.match(/ nps (.+)/);u&&(this.analysisinfo.nps=parseInt(u[1]));var h=null,c=t.match(/ pv (.+)/);if(c){var p=c[1].split(" ");h=p[0];for(var f=this.analyzedboard.getstate(),d=[],m=0,v=p;m<v.length;m+=1){var g=v[m];try{var y=this.analyzedboard.algebtomove(g);d.push(this.analyzedboard.movetosan(y)),this.analyzedboard.push(y)}catch(t){}}this.pvsans[h]=d,this.pvalgebs[h]=p,this.analyzedboard.setstate(f)}if(s){if(s<this.highestdepth)return;this.highestdepth=s}if(!h)return;var b=null,k=t.match(/ score cp (.+)/);k&&(b=parseInt(k[1]));var w=null,q=t.match(/ score mate (.+)/);q&&(w=parseInt(q[1]));var S=b;w&&(S=w<0?-1e4-w:1e4-w),this.pvs[h]={depth:this.highestdepth,scorecp:b,scoremate:w,scorenumerical:S};var x={};for(var C in this.pvs)this.pvs[C].depth>=this.highestdepth-1&&(x[C]=this.pvs[C]);this.pvs=x,this.sortedpvs=Object.keys(this.pvs).sort((function(t,i){return e.pvs[i].scorenumerical-e.pvs[t].scorenumerical})).sort((function(t,i){return e.pvs[i].depth-e.pvs[t].depth}));var P={};this.completeddepth=0;for(var _=0,I=this.sortedpvs.slice(0,this.multipv);_<I.length;_+=1){var T=I[_],E=this.pvs[T].depth;void 0!==P[E]?P[E]++:P[E]=1,P[E]>=this.multipv&&(this.completeddepth=E)}if(this.completeddepth>this.lastcompleteddepth){this.lastcompleteddepth=this.completeddepth;for(var N=[],O=0,A=0,M=this.sortedpvs.slice();A<M.length;A+=1){var R=M[A];O<this.multipv&&N.push({multipv:O+1,depth:this.lastcompleteddepth,uci:R,scorenumerical:this.pvs[R].scorenumerical,pvsans:this.pvsans[R],pvalgebs:this.pvalgebs[R]}),O++}this.analysisinfo.lastcompleteddepth=this.lastcompleteddepth,this.analysisinfo.summary=N,this.analysisinfo.lastcompleteddepth>=(this.minDepth?this.minDepth:0)&&this.sendanalysisinfo(this.analysisinfo)}}}},W.prototype.sendcommandtoengine=function(t){},W.prototype.issuecommand=function(t){this.sendcommandtoengine(t)},W.prototype.go=function(t){this.highestdepth=0,this.completeddepth=0,this.lastcompleteddepth=0,this.pvs={},this.pvsans={},this.pvalgebs={},this.sortedpvs=[],this.time=0,this.nodes=0,this.nps=0,this.multipv=t.multipv||1,this.threads=t.threads||1,this.analyzedfen=t.fen,this.moves=t.moves,this.timecontrol=t.timecontrol,this.variant=t.variant||"standard",this.analysiskey=t.analysiskey||"analysis/"+this.variant+"/"+e(this.analyzedfen),this.analyzedboard=N().setfromfen(this.analyzedfen,this.variant),this.moveOverHead=t.moveOverHead||1e3,this.analysisinfo={multipv:this.multipv,threads:this.threads,analyzedfen:this.analyzedfen,variant:this.variant,analysiskey:this.analysiskey,lastcompleteddepth:0,summary:[]},this.issuecommand("setoption name UCI_Variant value "+("standard"==this.variant?"chess":this.variant)),this.issuecommand("setoption name MultiPV value "+this.multipv),this.issuecommand("setoption name Threads value "+this.threads),this.issuecommand("setoption name Move Overhead value "+this.moveOverHead),this.issuecommand("position fen "+this.analyzedfen+(this.moves?" moves "+this.moves:""));var i="go"+(this.timecontrol?" wtime "+this.timecontrol.wtime+" winc "+this.timecontrol.winc+" btime "+this.timecontrol.btime+" binc "+this.timecontrol.binc:" infinite");this.issuecommand(i),this.analysisinfo.state=1,this.sendanalysisinfo(this.analysisinfo)},W.prototype.stop=function(){1==this.analysisinfo.state&&(this.issuecommand("stop"),this.analysisinfo.state=2,this.sendanalysisinfo(this.analysisinfo))},W.prototype.spawnengineprocess=function(){},W.prototype.spawn=function(){this.summary=["engine ready"],this.analysisinfo={state:0,summary:[],lastcompleteddepth:0,time:0,nodes:0,nps:0,multipv:null,analyzedfen:null,variant:null,threads:null,analysiskey:null},this.spawnengineprocess()},W.prototype.checkcommand=function(){this.command&&("go"==this.command&&(0!=this.analysisinfo.state?this.stop():(this.go(this.payload),this.command=null)),"stop"==this.command&&(this.stop(),this.command=null))};var Q=function(t){this.analysisinfo=t,this.board=N().setfromfen(t.analyzedfen,t.variant),this.lms=this.board.legalmovesforallpieces();for(var e=0,i=this.analysisinfo.summary;e<i.length;e+=1){var n=i[e],r=this.board.movefromalgeb(n.uci);n.move=r;var s=this.board.algebtomove(n.uci);s&&(n.san=this.board.movetosan(s),n.detailedmove=s)}this.analysisinfo.summary=this.analysisinfo.summary.filter((function(t){return t.pvsans.length>0}))},Y={hasScorenumerical:{configurable:!0},scorenumerical:{configurable:!0},running:{configurable:!0}};Y.hasScorenumerical.get=function(){return!!this.analysisinfo.summary.length&&"number"==typeof this.analysisinfo.summary[0].scorenumerical},Y.scorenumerical.get=function(){return this.hasScorenumerical?this.analysisinfo.summary[0].scorenumerical:null},Y.running.get=function(){return 0!=this.analysisinfo.state},Q.prototype.live=function(t){return this.isLive=t,this.running||(this.isLive=!1),this},Q.prototype.asText=function(){var t=this.isLive?" --\x3e nps "+(this.analysisinfo.nps||"0"):"";return"--\x3e "+(this.isLive?"running --\x3e":"stored  --\x3e")+" depth  "+(this.analysisinfo.lastcompleteddepth.toString().padEnd(3," ")+t)+"\n"+this.analysisinfo.summary.map((function(t){return t.pvsans[0].padEnd(8," ")+((t.scorenumerical<0?"":"+")+t.scorenumerical.toString()).padEnd(8," ")+"-> "+t.pvsans.slice(1,Math.min(t.pvsans.length,6)).join(" ")})).join("\n")},Object.defineProperties(Q.prototype,Y);var X=function(t){function e(e){t.call(this,e)}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.spawnengineprocess=function(){var t=this;this.stockfish=new Worker("/stockfish/stockfish.wasm.js"),this.stockfish.onmessage=function(e){t.processstdoutline(e.data)}},e.prototype.sendcommandtoengine=function(t){this.stockfish.postMessage(t)},e.prototype.terminate=function(){this.stockfish.terminate()},e}(W);t.exports={LocalEngine:X,ENGINE_READY:0,ENGINE_STOPPING:2,ENGINE_RUNNING:1}})),c=h.LocalEngine,p=h.ENGINE_READY,f=h.ENGINE_STOPPING,d=h.ENGINE_RUNNING;function v(t,e){var i=localStorage.getItem(t);if(null===i)return e;try{return JSON.parse(i)}catch(t){return e}}function g(t,e){localStorage.setItem(t,JSON.stringify(e,null,2))}var y={0:{class:"unrated"},1:{class:"forcedloss"},2:{class:"losing"},3:{class:"troll"},4:{class:"dubious"},5:{class:"experimental"},6:{class:"stable"},7:{class:"promising"},8:{class:"good"},9:{class:"winning"},10:{class:"forcedwin"}},b=function(t){this.blob={san:t,rating:0}},k={rating:{configurable:!0},class:{configurable:!0}};b.prototype.serialize=function(){return this.blob},b.prototype.deserialize=function(t){return this.blob={san:t.san,rating:t.rating||0},this},k.rating.get=function(){return this.blob.rating},k.rating.set=function(t){this.blob.rating=t},k.class.get=function(){return y[this.rating].class},Object.defineProperties(b.prototype,k);var w=function(t,e){this.blob={variant:t,fen:e,moves:{}},this.fromStored()},q={variant:{configurable:!0},fen:{configurable:!0},storeKey:{configurable:!0},moves:{configurable:!0}};q.variant.get=function(){return this.blob.variant},q.variant.set=function(t){this.blob.variant=t},q.fen.get=function(){return this.blob.fen},q.fen.set=function(t){this.blob.fen=t},q.storeKey.get=function(){return"bookposition/"+this.variant+"/"+this.fen},w.prototype.getStoredBlob=function(){return v(this.storeKey,this.blob)},w.prototype.storeBlob=function(){return g(this.storeKey,this.serialize()),this},w.prototype.fromStored=function(){var t=this.getStoredBlob();return this.deserialize(t)},q.moves.get=function(){return this.blob.moves},q.moves.set=function(t){this.blob.moves=t},w.prototype.serialize=function(){return{variant:this.variant,fen:this.fen,moves:Object.fromEntries(Object.entries(this.moves).map((function(t){return[t[0],t[1].serialize()]})))}},q.moves.get=function(){return this.blob.moves},w.prototype.getMove=function(t){var e=this.moves[t]||new b(t);return this.moves[t]=e,e},w.prototype.getRating=function(t){return this.getMove(t).rating},w.prototype.setRating=function(t,e){this.getMove(t).rating=e},w.prototype.getClass=function(t){return this.getMove(t).class},w.prototype.deserialize=function(t){return this.variant=t.variant,this.fen=t.fen,this.moves=Object.fromEntries(Object.entries(t.moves).map((function(t){return[t[0],(new b).deserialize(t[1])]}))),this},Object.defineProperties(w.prototype,q);var S=[1600,1800,2e3,2200,2500],x=["bullet","blitz","rapid","classical"],C={};function _(t,e,i,n,r){var s=t||"rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1",o=e||"standard",a=i||12,l=n||S,u=r||x,h=s+"|"+o+"|"+a+"|"+l+"|"+u;if(C[h])return Promise.resolve(C[h]);var c=l.map((function(t){return"ratings%5B%5D="+t})).join("&"),p=u.map((function(t){return"speeds%5B%5D="+t})).join("&"),f="https://explorer.lichess.ovh/lichess?fen="+s+"&moves="+a+"&variant="+o;return c&&(f+="&"+c),p&&(f+="&"+p),new Promise((function(t){!function(t,e,i){e.headers=e.headers||{},e.asForm&&(e.headers["Content-Type"]="application/x-www-form-urlencoded"),e.asJson&&(e.headers.Accept="application/json"),e.asVndLichessV3Json&&(e.headers.Accept="application/vnd.lichess.v3+json",e.asJson=!0),e.asNdjson&&(e.headers.Accept="application/x-ndjson"),e.accessToken&&(e.headers.Authorization="Bearer "+e.accessToken),e.server?api("request:fetch",{url:t,params:e},(function(t){return i(t)})):fetch(t,e).then((function(t){return t.text().then((function(t){if(e.asJson||e.asNdjson)try{var n;n=e.asNdjson?t.split("\n").filter((function(t){return t.length})).map((function(t){return JSON.parse(t)})):JSON.parse(t);try{i({ok:!0,content:n})}catch(t){console.log(t,n)}}catch(t){console.log("fetch parse json error",t),i({ok:!1,status:"Error: Could not parse json."})}else i({ok:!0,content:t})}),(function(t){console.log("fetch get response text error",t),i({ok:!1,status:"Error: Failed to get response text."})}))}),(function(t){console.log("fetch error",t),i({ok:!1,status:"Error: Failed to fetch."})}))}(f,{asJson:!0},(function(e){e.ok&&(e.content.fen=s,C[h]=e.content,t(e.content))}))}))}function I(t,e,i){return{display:t,chessops:e,explorer:i}}var T=[I("Standard","chess","standard"),I("Antichess","antichess","antichess"),I("Atomic","atomic","atomic"),I("Crazyhouse","crazyhouse","crazyhouse"),I("Horde","horde","horde"),I("King of the Hill","kingofthehill","kingOfTheHill"),I("Racing Kings","racingkings","racingKings")];function E(t){var e=T.find((function(e){return e.chessops===t}));return e?e.explorer:"standard"}var N={name:"VueCustomTooltip",props:{label:String,active:{type:Boolean,default:!0},sticky:Boolean,multiline:Boolean,underlined:Boolean,abbreviation:Boolean,position:{type:String,default:"is-top",validator:function(t){return["is-top","is-bottom","is-left","is-right"].indexOf(t)>-1}},size:{type:String,default:"is-medium",validator:function(t){return["is-small","is-medium","is-large"].indexOf(t)>-1}}},data:function(){return{labelText:this.label||null,isActive:this.active||!0,isSticky:this.sticky||!1,isMultiline:this.multiline||!1,isUnderlined:this.underlined||!1,isAbbreviation:this.abbreviation||!1,hasPosition:this.position||"is-top",hasSize:this.size||"is-medium"}},computed:{dynamicStyles:function(){return{"--vue-custom-tooltip-color":this.$vueCustomTooltip&&this.$vueCustomTooltip.hasOwnProperty("color")?this.$vueCustomTooltip.color:null,"--vue-custom-tooltip-background":this.$vueCustomTooltip&&this.$vueCustomTooltip.hasOwnProperty("background")?this.$vueCustomTooltip.background:null,"--vue-custom-tooltip-border-radius":this.$vueCustomTooltip&&this.$vueCustomTooltip.hasOwnProperty("borderRadius")?this.$vueCustomTooltip.borderRadius:null,"--vue-custom-tooltip-font-weight":this.$vueCustomTooltip&&this.$vueCustomTooltip.hasOwnProperty("fontWeight")?this.$vueCustomTooltip.fontWeight:null}}},watch:{label:{handler:function(t){this.labelText=t},immediate:!0},active:{handler:function(t){this.isActive=t},immediate:!0},sticky:{handler:function(t){this.isSticky=t},immediate:!0},multiline:{handler:function(t){this.isMultiline=t},immediate:!0},underlined:{handler:function(t){this.isUnderlined=t},immediate:!0},abbreviation:{handler:function(t){this.isAbbreviation=t},immediate:!0},position:{handler:function(t){this.hasPosition=t},immediate:!0},size:{handler:function(t){this.hasSize=t},immediate:!0}}};function O(t,e,i,n,r,s,o,a,l,u){"boolean"!=typeof o&&(l=a,a=o,o=!1);var h,c="function"==typeof i?i.options:i;if(t&&t.render&&(c.render=t.render,c.staticRenderFns=t.staticRenderFns,c._compiled=!0,r&&(c.functional=!0)),n&&(c._scopeId=n),s?(h=function(t){(t=t||this.$vnode&&this.$vnode.ssrContext||this.parent&&this.parent.$vnode&&this.parent.$vnode.ssrContext)||"undefined"==typeof __VUE_SSR_CONTEXT__||(t=__VUE_SSR_CONTEXT__),e&&e.call(this,l(t)),t&&t._registeredComponents&&t._registeredComponents.add(s)},c._ssrRegister=h):e&&(h=o?function(t){e.call(this,u(t,this.$root.$options.shadowRoot))}:function(t){e.call(this,a(t))}),h)if(c.functional){var p=c.render;c.render=function(t,e){return h.call(e),p(t,e)}}else{var f=c.beforeCreate;c.beforeCreate=f?[].concat(f,h):[h]}return i}var A,M="undefined"!=typeof navigator&&/msie [6-9]\\b/.test(navigator.userAgent.toLowerCase());function R(t){return function(t,e){return function(t,e){var i=M?e.media||"default":t,n=z[i]||(z[i]={ids:new Set,styles:[]});if(!n.ids.has(t)){n.ids.add(t);var r=e.source;if(e.map&&(r+="\n/*# sourceURL="+e.map.sources[0]+" */",r+="\n/*# sourceMappingURL=data:application/json;base64,"+btoa(unescape(encodeURIComponent(JSON.stringify(e.map))))+" */"),n.element||(n.element=document.createElement("style"),n.element.type="text/css",e.media&&n.element.setAttribute("media",e.media),void 0===A&&(A=document.head||document.getElementsByTagName("head")[0]),A.appendChild(n.element)),"styleSheet"in n.element)n.styles.push(r),n.element.styleSheet.cssText=n.styles.filter(Boolean).join("\n");else{var s=n.ids.size-1,o=document.createTextNode(r),a=n.element.childNodes;a[s]&&n.element.removeChild(a[s]),a.length?n.element.insertBefore(o,a[s]):n.element.appendChild(o)}}}(t,e)}}var z={};var B=O({render:function(){var t=this,e=t.$createElement;return(t._self._c||e)(t.isAbbreviation?"abbr":"span",{tag:"component",class:[t.hasPosition,t.hasSize,{"vue-custom-tooltip":t.isActive&&t.labelText,"is-sticky":t.isSticky,"has-multiline":t.isMultiline,"is-underlined":t.isUnderlined||t.isAbbreviation}],style:[t.dynamicStyles,{cursor:t.isAbbreviation?"help":"pointer"}],attrs:{"data-label":t.labelText,"aria-label":t.labelText,role:"tooltip"}},[t._t("default")],2)},staticRenderFns:[]},(function(t){t&&(t("data-v-60bf38c6_0",{source:".vue-custom-tooltip{--vue-custom-tooltip-color:#fff;--vue-custom-tooltip-background:#000;--vue-custom-tooltip-border-radius:100px;--vue-custom-tooltip-font-weight:400}",map:void 0,media:void 0}),t("data-v-60bf38c6_1",{source:".vue-custom-tooltip{position:relative;display:inline-block;text-decoration-line:none!important}.vue-custom-tooltip.is-top:after,.vue-custom-tooltip.is-top:before{top:auto;right:auto;bottom:calc(100% + 5px + 2px);left:50%;transform:translateX(-50%)}.vue-custom-tooltip.is-top:before{border-top:5px solid #000;border-top:5px solid var(--vue-custom-tooltip-background);border-right:5px solid transparent;border-left:5px solid transparent;bottom:calc(100% + 2px)}.vue-custom-tooltip.is-top.has-multiline.is-small:after{width:140px}.vue-custom-tooltip.is-top.has-multiline.is-medium:after{width:250px;padding:.6rem 1.25rem .65rem}.vue-custom-tooltip.is-top.has-multiline.is-large:after{width:480px;padding:0.6rem 1rem 0.65rem}.vue-custom-tooltip.is-right:after,.vue-custom-tooltip.is-right:before{top:50%;right:auto;bottom:auto;left:calc(100% + 5px + 2px);transform:translateY(-50%)}.vue-custom-tooltip.is-right:before{border-top:5px solid transparent;border-right:5px solid #000;border-right:5px solid var(--vue-custom-tooltip-background);border-bottom:5px solid transparent;left:calc(100% + 2px)}.vue-custom-tooltip.is-right.has-multiline.is-small:after{width:140px}.vue-custom-tooltip.is-right.has-multiline.is-medium:after{width:250px;padding:.6rem 1.25rem .65rem}.vue-custom-tooltip.is-right.has-multiline.is-large:after{width:480px;padding:0.6rem 1rem 0.65rem}.vue-custom-tooltip.is-bottom:after,.vue-custom-tooltip.is-bottom:before{top:calc(100% + 5px + 2px);right:auto;bottom:auto;left:50%;transform:translateX(-50%)}.vue-custom-tooltip.is-bottom:before{border-right:5px solid transparent;border-bottom:5px solid #000;border-bottom:5px solid var(--vue-custom-tooltip-background);border-left:5px solid transparent;top:calc(100% + 2px)}.vue-custom-tooltip.is-bottom.has-multiline.is-small:after{width:140px}.vue-custom-tooltip.is-bottom.has-multiline.is-medium:after{width:250px;padding:.6rem 1.25rem .65rem}.vue-custom-tooltip.is-bottom.has-multiline.is-large:after{width:480px;padding:0.6rem 1rem 0.65rem}.vue-custom-tooltip.is-left:after,.vue-custom-tooltip.is-left:before{top:50%;right:calc(100% + 5px + 2px);bottom:auto;left:auto;transform:translateY(-50%)}.vue-custom-tooltip.is-left:before{border-top:5px solid transparent;border-bottom:5px solid transparent;border-left:5px solid #000;border-left:5px solid var(--vue-custom-tooltip-background);right:calc(100% + 2px)}.vue-custom-tooltip.is-left.has-multiline.is-small:after{width:140px}.vue-custom-tooltip.is-left.has-multiline.is-medium:after{width:250px;padding:.6rem 1.25rem .65rem}.vue-custom-tooltip.is-left.has-multiline.is-large:after{width:480px;padding:0.6rem 1rem 0.65rem}.vue-custom-tooltip.is-underlined{border-bottom:1px dotted #000;border-bottom:1px dotted var(--vue-custom-tooltip-background);line-height:1.2}.vue-custom-tooltip:after,.vue-custom-tooltip:before{position:absolute;content:'';opacity:0;visibility:hidden;pointer-events:none;transition:opacity 86ms ease-out,visibility 86ms ease-out}.vue-custom-tooltip:before{z-index:889}.vue-custom-tooltip:after{content:attr(data-label);color:#fff;color:var(--vue-custom-tooltip-color);background:#000;background:var(--vue-custom-tooltip-background);width:auto;max-width:100vw;padding:.35rem .75rem .45rem;border-radius:100px;border-radius:var(--vue-custom-tooltip-border-radius);font-size:.85rem!important;font-weight:400;font-weight:var(--vue-custom-tooltip-font-weight);line-height:1.3;letter-spacing:normal!important;text-transform:none;box-shadow:0 1px 2px 1px rgba(0,1,0,.2);z-index:888;white-space:nowrap}.vue-custom-tooltip:not([data-label='']):hover:after,.vue-custom-tooltip:not([data-label='']):hover:before{opacity:1;visibility:visible}:disabled .vue-custom-tooltip{pointer-events:none}.vue-custom-tooltip:not([data-label='']).is-sticky:after,.vue-custom-tooltip:not([data-label='']).is-sticky:before{opacity:1;visibility:visible}.vue-custom-tooltip.has-multiline:after{display:block;padding:.5rem .75rem .65rem;text-align:center;line-height:1.4;white-space:pre-wrap}",map:void 0,media:void 0}))}),N,void 0,!1,void 0,!1,R,void 0,void 0),F={name:"VueCustomTooltip",color:"#fff",background:"#000",borderRadius:12,fontWeight:400},D=function(t,e){if(!D.installed&&!t.prototype.$isServer){D.installed=!0;var i=Object.assign({},e),n=/^#(?:[0-9A-Fa-f]{3}|[0-9A-Fa-f]{6})$/;i.hasOwnProperty("color")&&!n.test(i.color)&&delete i.color,i.hasOwnProperty("background")&&!n.test(i.background)&&delete i.background;i.hasOwnProperty("borderRadius")&&!/^[0-9]+$/.test(i.borderRadius)&&delete i.borderRadius;i.hasOwnProperty("fontWeight")&&!/^[1-9]{1}00$/.test(i.fontWeight)&&delete i.fontWeight;var r=Object.assign({},F,i);r.borderRadius=r.borderRadius+"px",t.prototype.$vueCustomTooltip=r,t.component(r.name,B)}},H={install:D},j=null;"undefined"!=typeof window?j=window.Vue:"undefined"!=typeof global&&(j=global.Vue),j&&j.use(H,F),B.install=D;function L(t,e,i,n,r,s,o,a,l,u){"boolean"!=typeof o&&(l=a,a=o,o=!1);var h,c="function"==typeof i?i.options:i;if(t&&t.render&&(c.render=t.render,c.staticRenderFns=t.staticRenderFns,c._compiled=!0,r&&(c.functional=!0)),n&&(c._scopeId=n),s?(h=function(t){(t=t||this.$vnode&&this.$vnode.ssrContext||this.parent&&this.parent.$vnode&&this.parent.$vnode.ssrContext)||"undefined"==typeof __VUE_SSR_CONTEXT__||(t=__VUE_SSR_CONTEXT__),e&&e.call(this,l(t)),t&&t._registeredComponents&&t._registeredComponents.add(s)},c._ssrRegister=h):e&&(h=o?function(t){e.call(this,u(t,this.$root.$options.shadowRoot))}:function(t){e.call(this,a(t))}),h)if(c.functional){var p=c.render;c.render=function(t,e){return h.call(e),p(t,e)}}else{var f=c.beforeCreate;c.beforeCreate=f?[].concat(f,h):[h]}return i}var G=L({render:function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("div",{staticClass:"trainvertcont"},[t.hastraining?i("div",{staticClass:"traincontrolsdiv"},[t.trainOn?i("div",{ref:"traininfo",staticClass:"traininfo"}):t._e(),t._v(" "),t.trainOn?t._e():i("button",{staticClass:"trainbutton",on:{click:t.train}},[t._v("Train")]),t._v(" "),t.trainOn&&!t.randLeft?i("button",{staticClass:"stoptrainbutton",on:{click:t.stoptrain}},[t._v("Stop Training")]):t._e()]):t._e(),t._v(" "),i("div",{ref:"gamecont",staticClass:"gamecont"},[i("div",{ref:"vuechessground",staticClass:"vuechessground"},[i("div",{ref:"disablediv",attrs:{id:"disablediv"}}),t._v(" "),t.settingsOpen?i("div",{staticClass:"settingsdiv",attrs:{id:"settingsdiv"}},[i("div",[t._v("\n                \n        "),i("div",{staticClass:"svgbutton cross floatright",on:{click:t.settings}})]),t._v(" "),i("div",{staticClass:"localstoragecontrols"},[i("div",{staticClass:"label"},[t._v("Local Storage")]),t._v(" "),i("button",{staticClass:"graybutton",on:{click:t.clearblob}},[t._v("Clear Blob")]),t._v(" "),i("button",{staticClass:"greenbutton",on:{click:t.copylocalstorage}},[t._v("Copy Local Storaga")]),t._v(" "),i("button",{staticClass:"yellowbutton",on:{click:t.setlocalstorage}},[t._v("Set Local Storage")]),t._v(" "),i("button",{staticClass:"redbutton",on:{click:t.clearlocalstorage}},[t._v("Clear Local Storaga")])]),t._v(" "),i("div",[i("textarea",{ref:"settingsblob",attrs:{id:"settingsblob"}})]),t._v(" "),i("div",{staticStyle:{"margin-top":"5px","margin-left":"4px"}},[i("Labeled",{attrs:{label:"Max games"}},[i("Perstext",{attrs:{id:"ui/maxgames",default:"50"}})],1),t._v(" "),i("Labeled",{attrs:{label:"Max multipv"}},[i("Perstext",{attrs:{id:"analysis/maxmultipv",default:"5"}})],1),t._v(" "),t.uploadapplycompression?i("Labeled",{attrs:{label:"Upload Apply Compression"}},[i("Perscheck",{attrs:{id:"upload/applycompression"}})],1):t._e()],1)]):t._e(),t._v(" "),i("div",{staticClass:"horizcont"},[i("div",{staticClass:"vertcont"},[i("div",{staticClass:"moveinputdiv"},[i("VueCustomTooltip",{attrs:{label:"flip board"}},[t.trainOn?t._e():i("div",{staticClass:"svgbutton spinner",on:{click:t.flip}})]),t._v(" "),i("VueCustomTooltip",{attrs:{label:"move text, san or uci"}},[i("input",{ref:"movetextinput",staticClass:"movetextinput",attrs:{type:"text"},on:{keyup:function(e){return!e.type.indexOf("key")&&t._k(e.keyCode,"enter",13,e.key,"Enter")?null:t.makemove.apply(null,arguments)}}})]),t._v(" "),t.showpromotion?i("div",{staticClass:"prompiecebuttons"},t._l(t.prompiecesext,(function(e){return i("div",{key:e.p,ref:e.p,refInFor:!0,class:e.klass,attrs:{piece:e.p},on:{click:t.prompiececlicked}},[t._v("\n                "+t._s(e.p.toUpperCase())+"\n              ")])})),0):t._e(),t._v(" "),i("VueCustomTooltip",{attrs:{label:"make text move"}},[t.showpromotion?t._e():i("div",{staticClass:"svgbutton checkmark greenbutton",on:{click:t.makemove}})]),t._v(" "),i("VueCustomTooltip",{attrs:{label:"cancel move"}},[i("div",{staticClass:"svgbutton cross yellowbutton",on:{click:t.makemovecancel}})]),t._v(" "),i("VueCustomTooltip",{attrs:{label:"reset board"}},[t.trainOn||t.showpromotion?t._e():i("div",{staticClass:"svgbutton exclam redbutton",on:{click:t.reset}})])],1),t._v(" "),i("div",{staticClass:"blue merida",on:{wheel:t.boardwheel}},[i("div",{ref:"board",staticClass:"cg-board-wrap"})]),t._v(" "),i("div",{staticClass:"fendiv"},[i("input",{ref:"fentextinput",staticClass:"fentextinput",attrs:{tytpe:"text"}})]),t._v(" "),t.trainOn?t._e():i("div",{staticClass:"controls"},[i("VueCustomTooltip",{attrs:{position:"is-bottom",label:"to begin"}},[i("div",{staticClass:"svgbutton tobegin bluebutton",on:{click:t.tobegin}})]),t._v(" "),i("VueCustomTooltip",{attrs:{position:"is-bottom",label:"back"}},[i("div",{staticClass:"svgbutton arrowleft greenbutton",on:{click:t.back}})]),t._v(" "),i("VueCustomTooltip",{attrs:{position:"is-bottom",label:"forward"}},[i("div",{staticClass:"svgbutton arrowright greenbutton",on:{click:t.forward}})]),t._v(" "),i("VueCustomTooltip",{attrs:{position:"is-bottom",label:"to end"}},[i("div",{staticClass:"svgbutton toend bluebutton",on:{click:t.toend}})]),t._v(" "),i("VueCustomTooltip",{attrs:{position:"is-bottom",label:"delete move"}},[i("div",{staticClass:"svgbutton cross redbutton",on:{click:t.del}})]),t._v(" "),i("VueCustomTooltip",{attrs:{position:"is-bottom",label:"select variant"}},[i("select",{ref:"variantselect",on:{change:t.variantchanged}},t._l(t.variants,(function(e){return i("option",{key:e.key,domProps:{value:e.key,selected:e.selected}},[t._v(t._s(e.display))])})),0)]),t._v(" "),i("VueCustomTooltip",{attrs:{position:"is-bottom",label:"weighted random book move"}},[i("div",{staticClass:"svgbutton questionmark yellowbutton",on:{click:t.makeWeightedrandom}})]),t._v(" "),i("VueCustomTooltip",{attrs:{position:"is-bottom",label:"open lichess analysis"}},[i("div",{staticClass:"svgbutton openfolder",on:{click:t.openanalysis}})]),t._v(" "),i("VueCustomTooltip",{attrs:{position:"is-bottom",label:"settings"}},[i("div",{staticClass:"svgbutton tool greenbutton",on:{click:t.settings}})])],1)]),t._v(" "),i("div",{staticClass:"legalsans"},t._l(t.legalsans,(function(e){return i("div",{key:e.key},[t.trainOn?t._e():i("div",{staticClass:"sancont"},[i("div",{class:e.klass,attrs:{san:e.san},on:{click:t.clicksan}},[t._v("\n                "+t._s(e.san)+"\n              ")]),t._v(" "),i("div",{staticClass:"sanbutton arrowdown red",attrs:{san:e.san},on:{click:t.sanratingminus}}),t._v(" "),i("div",{staticClass:"ratingnum"},[t._v("\n                "+t._s(e.rating<10?e.rating:"!")+"\n              ")]),t._v(" "),i("div",{staticClass:"sanbutton arrowup green",attrs:{san:e.san},on:{click:t.sanratingplus}})])])})),0),t._v(" "),i("div",{staticClass:"historysans"},t._l(t.history.slice().reverse(),(function(e){return i("div",{key:e.fen,staticClass:"historysanoutercont",attrs:{id:e.fen}},[i("div",{staticClass:"historysancont"},[i("div",{class:e.selected,attrs:{fen:e.fen,san:e.genSan},on:{click:t.clickhistory}},[t._v("\n                "+t._s(e.genSan)+"          \n              ")]),t._v(" "),i("div",{staticStyle:{width:"5px"}}),t._v(" "),e.prevFen?i("div",{staticClass:"sanbutton arrowdown red",attrs:{san:e.genSan,prevFen:e.prevFen},on:{click:t.sanratingminus}}):t._e(),t._v(" "),i("div",{staticClass:"ratingnum"},[t._v("\n                "+t._s(e.prevFen?e.rating<10?e.rating:"!":"")+"\n              ")]),t._v(" "),e.prevFen?i("div",{staticClass:"sanbutton arrowup green",attrs:{san:e.genSan,prevFen:e.prevFen},on:{click:t.sanratingplus}}):t._e()])])})),0),t._v(" "),i("div",{class:t.enginestate!==t.ENGINE_READY?"bookdiv running":"bookdiv"},[t.analyzing&&t.info||t.info?i("div",{staticStyle:{"margin-bottom":"20px"}},[t.enginestate===t.ENGINE_RUNNING?i("button",{staticStyle:{"background-color":"#faa","margin-top":"5px","margin-left":"5px","padding-left":"15px","padding-right":"15px"},on:{click:t.stopanalyzing}},[t._v("Stop")]):t._e(),t._v(" "),t.enginestate===t.ENGINE_RUNNING?i("button",{staticStyle:{"background-color":"#faf","margin-top":"5px","margin-left":"5px","padding-left":"15px","padding-right":"15px"},on:{click:t.stopnext}},[t._v("Stop Next")]):t._e(),t._v(" "),t.enginestate===t.ENGINE_RUNNING?i("button",{staticStyle:{"background-color":"#aff","margin-top":"5px","margin-left":"5px","padding-left":"15px","padding-right":"15px"},on:{click:t.nextall}},[t._v("Next All")]):t._e(),t._v(" "),t.enginestate===t.ENGINE_STOPPING?i("button",{staticStyle:{"background-color":"#ffa","margin-top":"5px","margin-left":"5px","padding-left":"15px","padding-right":"15px"},attrs:{disabled:!0}},[t._v("Stopping")]):t._e(),t._v(" "),t.enginestate===t.ENGINE_READY?i("button",{staticStyle:{"background-color":"#afa","margin-top":"5px","margin-left":"5px","padding-left":"15px","padding-right":"15px"},on:{click:t.analyze}},[t._v("Analyze")]):t._e(),t._v(" "),i("table",{staticClass:"infotable",attrs:{cellpadding:"10"}},[t._l(t.info.summary,(function(e){return[i("tr",[i("td",{staticClass:"multipv"},[t._v("\n                  "+t._s(e.multipv)+".\n                ")]),t._v(" "),i("td",{class:e.display===t.nextsan?"infosan next":"infosan",attrs:{uci:e.uci},on:{click:t.makeenginemove}},[t._v("\n                  "+t._s(e.display)+"\n                ")]),t._v(" "),i("td",{staticClass:"infoscore"},[t._v("\n                  "+t._s(e.scorenumerical)+"\n                ")]),t._v(" "),i("td",{staticClass:"infodepth"},[t._v("\n                  "+t._s(e.depth)+"\n                ")])]),t._v(" "),i("tr",[i("td"),t._v(" "),i("td",{staticClass:"infoline",attrs:{colspan:"3"}},[t._v("\n                  "+t._s(e.line?e.line.join(" "):"")+"\n                ")])])]}))],2)]):t._e(),t._v(" "),t.trainOn||t.enginestate!==t.ENGINE_READY?t._e():i("table",{attrs:{cellpadding:"2",cellspacing:"3"}},[i("thead",[i("tr",[i("td",[t.enginestate===t.ENGINE_READY?i("button",{staticStyle:{"font-size":"9px","background-color":"#afa","margin-bottom":"3px"},on:{click:t.analyze}},[t._v("Analyze")]):t._e()]),t._v(" "),i("td",{staticClass:"white"},[t._v("White")]),t._v(" "),i("td",{staticClass:"draw"},[t._v("Draw")]),t._v(" "),i("td",{staticClass:"black"},[t._v("Black")])])]),t._v(" "),i("tbody",t._l(t.bookmoves,(function(e){return i("tr",{key:e.san},[i("td",{staticClass:"bookmovesan",on:{click:function(i){return t.makesanmove(i,e.san)}}},[t._v("\n                  "+t._s(e.san)+"\n                ")]),t._v(" "),i("td",{staticClass:"white"},[t._v(t._s(e.white))]),t._v(" "),i("td",{staticClass:"draw"},[t._v(t._s(e.draws))]),t._v(" "),i("td",{staticClass:"black"},[t._v(t._s(e.black))])])})),0)])])])]),t._v(" "),t.lichessgames.length>0?i("div",{staticClass:"lichessgames"},t._l(t.lichessgames,(function(e){return i("div",{class:"lichessgame "+e.variant+e.lost+e.clicked,style:"opacity: "+e.diffOpacity+";",attrs:{id:e.id}},[i("span",{attrs:{index:e.index},on:{click:t.clicklichessgame}},[e.id===t.selectedgameid?i("span",{staticStyle:{color:"#00f"}},[t._v("\n            *\n          ")]):t._e(),t._v(" "),i("span",{staticStyle:{color:"#b87"}},[t._v("\n            "+t._s(e.index+1)+".\n          ")]),t._v("\n          "+t._s(e.gameInfo)+"\n        ")]),t._v(" "),i("a",{staticStyle:{"font-size":"12px"},attrs:{rel:"noopener noreferrer",target:"_blank",href:"https://lichess.org/"+e.id+e.orientation}},[t._v("open at lichess")])])})),0):t._e()])])},staticRenderFns:[]},void 0,{name:"Vuechessground",props:{nextdelay:{type:Number,default:3e3},nextalltimeout:{type:Number,default:1e4},prodhost:{type:String,default:"openingtrainer.netlify.app"},hastraining:{type:Boolean,default:!1},username:{type:String,default:""},uploadapplycompression:{type:Boolean,deafult:!1}},data:function(){var t=[{display:"Standard",key:"standard"},{display:"Atomic",key:"atomic"},{display:"Antichess",key:"antichess"},{display:"Crazyhouse",key:"crazyhouse"},{display:"Horde",key:"horde"},{display:"Racing Kings",key:"racingkings"},{display:"Three Check",key:"3check"}],e=v("board/selectedvariant","standard");return this.selectVariant(t,e),{pos:r(),board:null,legalsans:[],history:v("board/history",[]),variants:t,promuci:null,showpromotion:!1,prompieces:[],prompiecesext:[],currentbook:null,bookmoves:[],orientation:v("board/orientation","white"),firstVariantChanged:!0,randLeft:0,trainOn:!1,expectedMoves:[],getExpected:!1,awaitTrainMove:!1,trainTimeout:null,sankey:0,settingsOpen:!1,lichessgames:[],allowSetup:!0,clickedgame:null,rawgames:[],selectedgameid:null,analyzing:!1,info:null,enginestate:p,ENGINE_READY:p,ENGINE_STOPPING:f,ENGINE_RUNNING:d,authstoreInfo:"",nextsan:null,oldstate:null,nextallOn:!1}},methods:{nextall:function(){this.nextallOn=!0,this.stopnext()},checkstate:function(t){var e=this;this.oldstate!==d&&this.oldstate!==f||t===p&&this.onStopStepAndStart&&(this.onStopStepAndStart=!1,setTimeout((function(t){e.step(1),e.getCurrentIndex()<e.history.length-1?e.analyze():(e.nextallOn=!1,e.onStopStepAndStart=!1)}),this.nextdelay)),this.oldstate=t},stopnext:function(){var t=this.nextallOn;this.stopanalyzing(),this.nextallOn=t,console.log("stopnext",this.nextallOn),this.onStopStepAndStart=!0},makeenginemove:function(t){var e=t.target.getAttribute("uci"),i=this.pos.uciToSan(e);try{this.$refs.movetextinput.value=i,this.makemove()}catch(t){}},infoStoreKey:function(t){var e=t||this.reportFen();return"analysisinfo/"+this.pos.pos.rules+"/"+e},mymoveShapes:function(){var t=this.getCurrentIndex();if(t<this.history.length-1){var e=this.history[t+1].genUci;return[{orig:e.substring(0,2),brush:"yellow"},{orig:e.substring(2,4),brush:"yellow"}]}return[]},stopanalyzing:function(){this.engine&&this.engine.setcommand("stop",{}),this.analyzing=!1,this.nextallOn=!1},analyze:function(){var t=this;this.pos.pos.rules,this.analyzing=!0,this.setUp(),console.log("analyze",this.nextallOn),this.nextallOn&&(console.log("setting nextall timeout"),setTimeout((function(e){console.log("nextall timeout"),t.stopnext()}),this.nextalltimeout))},boardwheel:function(t){this.step(t.deltaY>0?-1:1)},setFen:function(t){try{return this.pos.setFen(t),t}catch(e){return console.log("could not set fen "+t),null}},buildlichessgames:function(t){var e=this,i=t.map((function(t){return new s.lichess.ParsedGame(t)}));this.lichessgames=i.map((function(t,i){t.index=i,t.lost="",t.orientation="/";var n,r,s=parseInt(t.decoratedWhite.split(" ")[2]),o=parseInt(t.decoratedBlack.split(" ")[2]);t.white==e.username&&(t.orientation="/white",n=s,r=o),t.black==e.username&&(t.orientation="/black",n=o,r=s);var a=n-r,l=1;return a>200&&(l=.8),a>400&&(l=.6),a>600&&(l=.4),t.diffOpacity=l,t.white==e.username&&"0-1"==t.result&&(t.lost=" lost"),t.black==e.username&&"1-0"==t.result&&(t.lost=" lost"),t.clicked=i===e.clickedgame?" clickedgame":"",t})),setTimeout((function(t){if(e.selectedgameid){var i=document.getElementById(e.selectedgameid);i&&i.scrollIntoView({block:"center",behavior:"smooth"})}}),0)},clicklichessgame:function(t){var e=parseInt(t.target.getAttribute("index"));this.clickedgame=e,this.allowSetup=!1;var i,n,r=this.lichessgames[e];this.selectedgameid=r.id,localStorage.setItem("ui/selectedgameid",this.selectedgameid),this.variantchanged(null,(i=r.variant,(n=T.find((function(t){return t.explorer===i})))?n.chessops:"chess"));for(var s=0,o=r.moves;s<o.length;s+=1){var a=o[s];this.makesanmove(null,a)}this.allowSetup=!0,r.white===this.username&&(this.orientation="white"),r.black===this.username&&(this.orientation="black"),g("board/orientation",this.orientation),this.setUp(),this.buildlichessgames(this.rawgames)},getGames:function(){var t=this,e=this.username;if(e){var i=new s.FetchClient(window.fetch.bind(window),{apiBaseUrl:"https://lichess.org/api",bearer:localStorage.getItem("LICHESS_TOKEN")||void 0}).extend("games/user",{headers:{Accept:"application/x-ndjson"}}),n="bullet,blitz,rapid,classiscal";"chess"!==this.pos.pos.rules&&(n=E(this.pos.pos.rules)),i.fetchNdJson(e,{urlParams:{max:v("ui/maxgames"),perfType:n}}).then(function(e){t.rawgames=e,t.buildlichessgames(t.rawgames)}.bind(this))}},clearblob:function(){this.$refs.settingsblob.value=""},setlocalstorage:function(){var t=this,e=this.$refs.settingsblob.value.split("\n--------------------\n");this.$refs.settingsblob.value="Setting from "+e.length+" entry(s) .",setTimeout((function(i){try{var n=e.map((function(t){return JSON.parse(t)}));localStorage.clear(),n.forEach((function(t){return localStorage.setItem(t[0],t[1])})),t.$refs.settingsblob.value="Set "+n.length+" items, ok . Reloading.",setTimeout((function(t){document.location.reload()}),1e3)}catch(e){t.$refs.settingsblob.value="A problem occured with setting from blob. "+e}}),1e3)},confirm:function(t){var e=window.prompt(t+" indeed ? ( y = yes )");return!!e&&"y"===e.toLowerCase()},clearlocalstorage:function(){this.confirm("Clear Local storage")?(localStorage.clear(),this.$refs.settingsblob.value="Local Storage cleared. Reloading.",setTimeout((function(t){document.location.reload()}),1e3)):this.$refs.settingsblob.value="Clearing Local Storage canceled."},copylocalstorage:function(){var t=Object.entries(localStorage).map((function(t){return JSON.stringify(t)})).join("\n--------------------\n");this.$refs.settingsblob.value=t,this.$refs.settingsblob.select(),document.execCommand("copy")},settings:function(){this.settingsOpen=!this.settingsOpen},sanratingstep:function(t,e,i){var n=this.reportFen();if(n){var r=i||n,s=this.pos.pos.rules,o=new w(s,r);o.blob.variant=s,o.blob.fen=r;var a=o.getRating(t)+e;a<0&&(a=10),a>10&&(a=0),o.setRating(t,a),o.storeBlob(),this.buildLegalSans()}},sanratingminus:function(t){this.sanratingstep(t.target.getAttribute("san"),-1,t.target.getAttribute("prevFen"))},sanratingplus:function(t){this.sanratingstep(t.target.getAttribute("san"),1,t.target.getAttribute("prevFen"))},showRandLeft:function(){var t=this;this.trainOn&&setTimeout((function(e){t.$refs.traininfo.innerHTML='<span class="settingupopeningpos">Setting up opening position ( left '+t.randLeft+" ) ...</span>"}),0)},trainmoveplayed:function(t){var e=this;if(this.trainOn){var i=this.expectedMoves.findIndex((function(e){return e.san==t}));this.$refs.traininfo.innerHTML=i<0?'<span class="trainerror">Not among book moves !</span>':'<div class="trainrankdiv"><span class="trainok">Move <span class="trainrank">'+t+'</span> was <span class="trainrank">Rank '+(i+1)+'.</span> most played.</div><div><span class="trainok">Among <span class="trainexps">'+this.expectedMoves.map((function(t,e){return e+1+". "+t.san})).join(" ")+"</span> .</span></div>",this.trainTimeout=setTimeout((function(t){e.awaitTrainMove=!1,e.trainOn&&e.train(),e.trainTimeout=null}),5e3)}},train:function(){this.trainOn=!0,this.rndpos()},stoptrain:function(){this.trainOn=!1,this.awaitTrainMove=!1,this.randLeft=0,this.trainTimeout&&clearTimeout(this.trainTimeout),this.trainTimeout=null},rndpos:function(){this.variantchanged(),this.disable(),this.randLeft=3+Math.floor(10*Math.random()),(this.randLeft%2?"black":"white")!=this.orientation&&this.flip(),this.showRandLeft(),this.makeWeightedrandom()},disable:function(){var t=this.$refs.vuechessground.getBoundingClientRect(),e=this.$refs.disablediv.style;e.width=t.width-12+"px",e.height=t.height-12+"px"},enable:function(){var t=this.$refs.disablediv.style;t.width="0px",t.height="0px"},selectVariant:function(t,e){t.forEach((function(t){t.selected=t.key===e})),g("board/selectedvariant",e)},flip:function(){this.orientation="white"==this.orientation?"black":"white",g("board/orientation",this.orientation),this.setUp()},openanalysis:function(){var t=E(this.pos.pos.rules),e=this.reportFen();if(e){var i="https://lichess.org/analysis/"+t+"/"+e;window.open(i,"_blank")}},getCurrent:function(){var t=this.reportFen();return t?this.history.find((function(e){return e.fen===t})):this.history[0]},getCurrentIndex:function(){var t=this.reportFen();return t?this.history.findIndex((function(e){return e.fen===t})):0},getBook:function(){var t=this;this.currentbook=null,this.bookmoves=[];var e=this.reportFen();e&&_(e,E(this.pos.pos.rules)).then((function(e){t.currentbook=e,t.bookmoves=e.moves,t.trainOn&&(t.randLeft||t.awaitTrainMove||(t.expectedMoves=t.bookmoves.map((function(t){return{san:t.san,totalPlays:t.white+t.draws+t.black}})).sort((function(t,e){return e.totalPlays-t.totalPlays})),t.$refs.traininfo.innerHTML='<span class="makeyourmove">Make your move !</span>',t.awaitTrainMove=!0,t.orientation="w"===t.getCurrent().fen.split(" ")[1]?"white":"black",g("board/orientation",t.orientation),t.setUp(!0)))}))},makeWeightedrandom:function(){var t=this,e=this.reportFen();if(e)if(this.currentbook)if(this.currentbook.fen===e){var i=function(t){if(!t)return null;if(!t.moves.length)return null;for(var e=0,i=0,n=t.moves;i<n.length;i+=1){var r=n[i];r.total=r.white+r.draws+r.black,e+=r.total}for(var s=Math.floor(Math.random()*e),o=t.moves[0].total,a=0;o<s;)o+=t.moves[a++].total;return t.moves[a]}(this.currentbook);if(!i)return this.randLeft=0,this.trainOn=!1,void this.enable();var n=i.san;this.makesanmove(null,n),this.randLeft&&this.randLeft--,this.trainOn&&this.randLeft?(this.showRandLeft(),setTimeout((function(e){t.makeWeightedrandom()}),250)):(this.randLeft=0,this.enable())}else this.randLeft?setTimeout((function(e){t.makeWeightedrandom()}),250):this.enable();else this.randLeft?setTimeout((function(e){t.makeWeightedrandom()}),250):this.enable()},makemovecancel:function(){var t=this;this.prompieces=[],this.prompiecesext=[],this.showpromotion=!1,this.$refs.movetextinput.value="",setTimeout((function(e){t.setUp()}),250)},pieceToName:function(t){return{q:"queen",r:"rook",b:"bishop",n:"knight",k:"king",p:"pawn"}[t]},pieceToStyle:function(t,e){var i="w"==e.split(" ")[1]?"white":"black";return"piece "+this.pieceToName(t)+" "+i},step:function(t){var e=this.reportFen();if(e){var i=this.history.findIndex((function(t){return t.fen===e}));if(!(i<0)&&((i+=t)<0&&(i=0),i>=this.history.length&&(i=this.history.length-1),this.setFen(this.history[i].fen))){this.getSelectedHistory(),this.setUp(),this.prompieces=[],this.prompiecesext=[];var n=this.nextallOn;this.stopanalyzing(),this.nextallOn=n}}},tobegin:function(){this.step(-100)},back:function(){this.step(-1)},forward:function(){this.step(1)},toend:function(){this.step(100)},del:function(){this.back();var t=this.reportFen();if(t){var e=this.history.findIndex((function(e){return e.fen===t}));e>=0&&(this.history=this.history.slice(0,e+1))}},clickhistory:function(t){if(this.trainOn)return window.alert("Not allowed in train mode.");var e=t.target.getAttribute("fen");if(this.setFen(e)){this.getSelectedHistory();var i=this.history.findIndex((function(t){return t.isSelected}));this.recordMovePlayed(this.history[i].genSan,this.history[i].genUci,i>0?this.history[i-1].fen:null,!0)}},reportFen:function(){try{return this.pos.reportFen()}catch(t){return console.log("could not report fen"),null}},getSelectedHistory:function(){var t=this.reportFen();if(t){for(var e=0,i=this.history;e<i.length;e+=1){var n=i[e],r=new w(this.pos.pos.rules,n.prevFen);n.isSelected=n.fen==t,n.rating=r.getRating(n.genSan),n.selected="historysan "+(n.isSelected?"histactive":"histpassive")+" "+r.getClass(n.genSan)}setTimeout((function(e){var i=document.getElementById(t);i&&i.scrollIntoView({block:"center",behavior:"smooth"})}),0)}},recordMovePlayed:function(t,e,i,n){var r=this.reportFen();if(r){if(!n){var s=this.history.findIndex((function(t){return t.fen===i}));s<0||(this.history=this.history.slice(0,s+1)),this.history.push({genSan:t,genUci:e,prevFen:i,fen:r})}this.getSelectedHistory(),this.prompieces=[],this.prompiecesext=[],this.allowSetup&&this.setUp();var o={kind:"moveplayed",prevFen:i,fen:r,genSan:t,genUci:e,variant:this.pos.pos.rules,history:this.history};this.$emit("moveplayed",o);var a=this.nextallOn;this.nextallOn=a}},prompiececlicked:function(t){var e=t.target.getAttribute("piece"),i=this.promuci+e,n=this.pos.uciToSan(i);this.$refs.movetextinput.value=n,this.showpromotion=!1},makesanmove:function(t,e){this.$refs.movetextinput.value=e,this.makemove()},makemove:function(){var t=this.reportFen();if(t){var e=this.$refs.movetextinput.value;if(this.$refs.movetextinput.value="",e!==this.nextsan)try{var i=this.pos.sanToUci(e);this.pos.playSan(e),this.recordMovePlayed(e,i,t)}catch(i){try{var n=this.pos.uciToSan(e);this.pos.playSan(n),this.recordMovePlayed(n,e,t)}catch(t){return}}else this.step(1)}},variantchanged:function(t,e){var i=e||(this.$refs.variantselect?this.$refs.variantselect.value:this.pos.pos.rules);if(this.selectVariant(this.variants,i),this.pos.setVariant(i),this.history=this.firstVariantChanged?v("board/history",[]):[],this.firstVariantChanged=!1,this.history.length){var n=this.history.find((function(t){return t.isSelected}));if(!this.setFen(n.fen))return;this.setUp()}else this.recordMovePlayed("*","*",null)},reset:function(){this.variantchanged()},clicksan:function(t){var e=this.reportFen();if(e){var i=t.target.getAttribute("san"),n=this.pos.sanToUci(i);i===this.nextsan?this.step(1):(this.pos.playSan(i),this.recordMovePlayed(i,n,e))}},buildLegalSans:function(){var t=this,e=this.reportFen();if(e){var i=new w(this.pos.pos.rules,e),n=[],r=this.pos.allLegalSans();this.legalsans=r.map((function(e){var r=t.pos.sanToUci(e),s=r.substring(0,2),o=r.substring(2,4),a=null,l=t.getCurrentIndex();l>=0&&l+1<t.history.length&&(a=t.history[l+1].genSan),t.nextsan=a;var u=0,h="legalsan";e===a&&(h+=" histsan",u=1e3);var c=i.getRating(e),p="red";return c>3&&(p="blue"),c>6&&(p="green"),c&&n.push({orig:s,dest:o,brush:p}),u+=100*c,{san:e,klass:h+=" "+i.getClass(e),rating:c,sortvalue:u,key:t.sankey++}})).sort((function(t,e){return t.san.localeCompare(e.san)})).sort((function(t,e){return e.sortvalue-t.sortvalue})),this.board.setShapes(n.concat(this.mymoveShapes())),this.getSelectedHistory()}},setUp:function(t){var e=this,i=this.reportFen();if(i){this.$refs.fentextinput.value=i;var r={fen:i,movable:{events:{after:this.movePlayed()}},orientation:this.orientation};this.board=n(this.$refs.board,r);try{var s=this.getCurrent().genUci;if(s.length>=4){var o=[s.substring(0,2),s.substring(2,4)];this.board.set({lastMove:o})}}catch(t){window.alert("could not highlight move "+t)}if(this.buildLegalSans(),g("board/history",this.history),t||this.getBook(),this.analyzing){var a=parseInt(v("analysis/maxmultipv")),l=this.pos.allLegalSans().length;if(0===l)return window.alert("No legal moves to analyze !"),void(this.analyzing=!1);l<a&&(a=l);var u=this.pos.pos.rules,h=this.pos.pos.rules;"antichess"==u&&(h="giveaway"),"3check"==u&&(h="threecheck");var c={variant:h,fen:i,multipv:a};console.log("payload",c),this.engine&&this.engine.setcommand("go",c)}else this.info=null,t||this.authStore.getItem(this.infoStoreKey()).then((function(t){t&&(e.info=t)}))}},movePlayed:function(){var t=this;return function(e,i,n){var r=t.reportFen();if(r){var s=""+e+i,o=t.pos.legalsForUci(s),a=o.length;if(!a)return t.$refs.movetextinput.value="",t.showpromotion=!1,void t.setUp();if(a>1){t.prompieces=o.map((function(t){return t.substring(4,5)}));var l=t.reportFen();if(!l)return;return t.prompiecesext=t.prompieces.map((function(e){return{p:e,klass:"prompiecediv "+t.pieceToStyle(e,l)}})),t.showpromotion=!0,t.$refs.movetextinput.value="Press piece !",void(t.promuci=s)}t.$refs.movetextinput.value="",t.showpromotion=!1;var u=t.pos.uciToSan(s);u===t.nextsan?t.step(1):(t.pos.playSan(u),t.recordMovePlayed(u,s,r)),t.trainmoveplayed(u)}}}},mounted:function(){var t=this;this.authStore=new l({vm:this,prodHost:this.prodhost,isRemoteKey:function(t){return t.match(/^analysisinfo/)}}),this.selectedgameid=localStorage.getItem("ui/selectedgameid"),this.variantchanged(),this.getGames(this.username),this.engine=new c((function(e){t.checkstate(e.state),t.info=e,t.info.state===p&&(t.enginestate=p),t.info.state===d&&(t.enginestate=d),t.info.state===f&&(t.enginestate=f);var i={summary:t.info.summary};t.authStore.setItem(t.infoStoreKey(t.info.analyzedfen),i);var n=t.info.summary.map((function(e,i){e.display=e.uci;try{var n=r();n.setVariant(t.pos.pos.rules),n.setFen(t.info.analyzedfen),e.display=n.uciToSan(e.uci);var s=e.pvalgebs.map((function(t){var e=n.uciToSan(t);return n.playSan(e),e}));e.line=s.slice(1,Math.min(s.length,5))}catch(t){}var o="green";return i>0&&(o="blue"),i>1&&(o="yellow"),i>2&&(o="red"),{orig:e.uci.substring(0,2),dest:e.uci.substring(2,4),brush:o}}));t.board.setShapes(n.concat(t.mymoveShapes()))})),console.log("engine",this.engine),setInterval((function(e){var i=t.engine.analysisinfo.state;t.checkstate(i),i===p&&(t.enginestate=p),i===d&&(t.enginestate=d),i===f&&(t.enginestate=f)}),500)},components:{VueCustomTooltip:B,Labeled:t,Perstext:e,Perscheck:i}},void 0,!1,void 0,!1,void 0,void 0,void 0);function U(t){U.installed||(U.installed=!0,t.component("Vuechessground",G))}var $={install:U},K=null;"undefined"!=typeof window?K=window.Vue:"undefined"!=typeof global&&(K=global.Vue),K&&K.use($),G.install=U;export{G as default};
//# sourceMappingURL=vuechessground.esm.js.map
